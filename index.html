<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Sik-BUMDes (Diperbaiki)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Custom scrollbar for webkit browsers */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark ::-webkit-scrollbar-track { background: #2d3748; }
        .dark ::-webkit-scrollbar-thumb { background: #718096; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #a0aec0; }

        /* Sidebar and Main Content transition */
        #sidebar, #main-wrapper { transition: all 0.3s ease-in-out; }
        
        /* Modal styles */
        .modal { display: none; }
        .modal.show { display: flex; }

        /* Theme Variables */
        :root {
            --color-primary-start: #2dd4bf; /* teal-400 */
            --color-primary-end: #3b82f6; /* blue-600 */
            --color-primary-light: #ccfbf1; /* teal-100 */
            --color-primary-dark: #115e59; /* teal-800 */
            --color-primary-text: #0d9488; /* teal-600 */
            --color-accent-start: #60a5fa; /* blue-400 */
            --color-accent-end: #a78bfa; /* violet-400 */
        }
        
        /* Print styles */
        @media print {
            body * { visibility: hidden; }
            #print-area, #print-area * { visibility: visible; }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 0;
                margin: 0;
            }
            .no-print { display: none; }
            .report-table { font-size: 10pt; }
            .struktur-organisasi { page-break-inside: avoid; }
            .nametag-print-container {
                width: 7cm !important;
                height: 10cm !important;
            }
        }
        .report-table th, .report-table td { padding: 4px 8px; }
        .report-table .level-1 { font-weight: bold; }
        .report-table .level-2 { padding-left: 20px !important; }
        .report-table .level-3 { padding-left: 40px !important; }
        .report-table .total-row { font-weight: bold; border-top: 1px solid #ccc; }
        
        /* Organization Chart Styles */
        .org-card {
            background: white;
            border: 2px solid transparent;
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            width: 220px;
            min-height: 130px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        .org-card-title {
            padding: 8px;
            border-radius: 0.5rem;
            background-image: linear-gradient(to right, var(--color-primary-start), var(--color-primary-end));
            color: white;
        }
        .dark .org-card {
            background: #2d3748;
        }
        .org-connector {
            border-color: #9ca3af; /* gray-400 */
            border-width: 2px;
        }
        .dark .org-connector {
            border-color: #4a5568; /* gray-600 */
        }
        .org-connector-dashed {
            border-style: dashed;
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans">

    <!-- Notifikasi Update Aplikasi -->
    <div id="update-notification" class="hidden fixed top-0 left-0 right-0 bg-yellow-400 text-yellow-900 text-center p-2 z-[102] shadow-lg">
        Versi baru aplikasi tersedia! Mohon segarkan halaman dengan menekan <strong>Ctrl + Shift + R</strong> (atau <strong>Cmd + Shift + R</strong> di Mac) untuk memperbarui.
    </div>

    <div id="login-page" class="fixed inset-0 bg-gradient-to-br from-[var(--color-primary-start)] to-[var(--color-primary-end)] flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-2xl shadow-2xl w-full max-w-sm">
            <div class="flex justify-center mb-6">
                <i class="fas fa-landmark fa-3x text-[var(--color-primary-text)]"></i>
            </div>
            <h2 class="text-2xl font-bold text-center text-gray-800 dark:text-white mb-2">Sik-BUMDes Login</h2>
            <p class="text-center text-gray-500 dark:text-gray-400 mb-6">Selamat Datang Kembali</p>
            <form id="login-form">
                <div class="mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Username</label>
                    <input type="text" id="username" name="username" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-primary-text)]" required value="">
                </div>
                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-2">Password</label>
                    <input type="password" id="password" name="password" class="w-full px-4 py-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-[var(--color-primary-text)]" required value="">
                </div>
                <button type="submit" class="w-full bg-gradient-to-r from-[var(--color-primary-start)] to-[var(--color-primary-end)] text-white font-bold py-2 px-4 rounded-lg transition duration-300 hover:opacity-90">Login</button>
                <p id="login-error" class="text-red-500 text-sm mt-4 text-center h-4"></p>
            </form>
        </div>
    </div>

    <div id="app-wrapper" class="hidden">
        <aside id="sidebar" class="bg-white dark:bg-gray-800 text-gray-800 dark:text-white w-64 fixed inset-y-0 left-0 z-40 shadow-lg transform -translate-x-full lg:translate-x-0 flex flex-col">
            <div class="p-4 flex items-center justify-center border-b border-gray-200 dark:border-gray-700">
                <i class="fas fa-landmark fa-2x text-[var(--color-primary-text)] mr-3"></i>
                <h1 class="text-2xl font-bold">Sik-BUMDes</h1>
            </div>
            <nav class="p-4 flex-1 overflow-y-auto">
                <ul class="space-y-2">
                    <li><a href="#home" class="nav-link active flex items-center p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white transition-colors"><i class="fas fa-home w-6 mr-3"></i>Dashboard</a></li>
                    <li><a href="#input-data" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white transition-colors"><i class="fas fa-keyboard w-6 mr-3"></i>Input Data</a></li>
                    <li><a href="#unit-usaha" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white transition-colors"><i class="fas fa-store w-6 mr-3"></i>Unit Usaha</a></li>
                    <li><a href="#laporan" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white transition-colors"><i class="fas fa-file-alt w-6 mr-3"></i>Laporan</a></li>
                    <li><a href="#administrasi" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white transition-colors"><i class="fas fa-folder-open w-6 mr-3"></i>Administrasi</a></li>
                    <li><a href="#pengaturan" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white transition-colors"><i class="fas fa-cog w-6 mr-3"></i>Pengaturan</a></li>
                    <li><a href="#bantuan" class="nav-link flex items-center p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white transition-colors"><i class="fas fa-question-circle w-6 mr-3"></i>Bantuan</a></li>
                </ul>
            </nav>
            <div class="p-4 border-t border-gray-200 dark:border-gray-700">
                 <a href="#" id="logout-btn" class="flex items-center justify-center p-3 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors"><i class="fas fa-sign-out-alt w-6 mr-3"></i>Logout</a>
            </div>
        </aside>

        <div id="main-wrapper" class="flex flex-col flex-1 lg:ml-64">
            <header class="bg-white dark:bg-gray-800 shadow-md p-4 flex justify-between items-center sticky top-0 z-30 no-print">
                <div class="flex items-center">
                     <button id="menu-toggle" class="text-gray-600 dark:text-gray-300 focus:outline-none lg:hidden">
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                    <h2 id="page-title" class="text-xl font-semibold ml-4">Dashboard</h2>
                </div>
                <div class="flex items-center">
                    <button id="theme-toggle" class="mr-4 text-gray-600 dark:text-gray-300 focus:outline-none">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div id="user-info" class="text-right">
                        <p class="font-semibold">Nama Pengguna</p>
                        <p class="text-sm text-gray-500">Peran</p>
                    </div>
                </div>
            </header>

            <main id="main-content" class="flex-1 p-6 overflow-y-auto">
                
                <div id="home-page" class="page">
                    <div class="bg-gradient-to-r from-[var(--color-primary-start)] to-[var(--color-primary-end)] text-white p-6 rounded-xl shadow-lg mb-6">
                        <div class="flex items-center">
                            <img id="dashboard-logo" src="" alt="Logo BUMDes" class="w-20 h-20 rounded-full mr-6 object-cover bg-white/30">
                            <div>
                                <h2 id="dashboard-nama-bumdes" class="text-3xl font-bold">Nama BUMDes</h2>
                                <p id="dashboard-alamat" class="mt-1">Alamat Lengkap BUMDes</p>
                                <p id="dashboard-ahu" class="text-sm bg-white text-[var(--color-primary-text)] font-bold px-3 py-1 rounded-full inline-block mt-2">Nomor AHU: -</p>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6 mb-6">
                        <div class="bg-gradient-to-br from-teal-400 to-emerald-500 text-white p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-white/20 p-4 rounded-full mr-4"><i class="fas fa-wallet fa-2x"></i></div>
                            <div><p class="font-light">Total Aktiva</p><p id="summary-aktiva" class="text-2xl font-bold">Rp 0</p></div>
                        </div>
                        <div class="bg-gradient-to-br from-sky-400 to-blue-500 text-white p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-white/20 p-4 rounded-full mr-4"><i class="fas fa-balance-scale fa-2x"></i></div>
                            <div><p class="font-light">Total Pasiva</p><p id="summary-pasiva" class="text-2xl font-bold">Rp 0</p></div>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-400 to-purple-500 text-white p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-white/20 p-4 rounded-full mr-4"><i class="fas fa-landmark fa-2x"></i></div>
                            <div><p class="font-light">Modal Dari Desa</p><p id="summary-modal-desa" class="text-2xl font-bold">Rp 0</p></div>
                        </div>
                        <div class="bg-gradient-to-br from-amber-400 to-orange-500 text-white p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-white/20 p-4 rounded-full mr-4"><i class="fas fa-chart-line fa-2x"></i></div>
                            <div><p class="font-light">Laba Rugi Tahun Ini</p><p id="summary-laba-rugi" class="text-2xl font-bold">Rp 0</p></div>
                        </div>
                        <div class="bg-gradient-to-br from-lime-400 to-green-500 text-white p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-white/20 p-4 rounded-full mr-4"><i class="fas fa-arrow-up fa-2x"></i></div>
                            <div><p class="font-light">Pendapatan Bulan Ini</p><p id="summary-pendapatan" class="text-2xl font-bold">Rp 0</p></div>
                        </div>
                        <div class="bg-gradient-to-br from-rose-400 to-red-500 text-white p-5 rounded-xl shadow-md flex items-center">
                            <div class="bg-white/20 p-4 rounded-full mr-4"><i class="fas fa-arrow-down fa-2x"></i></div>
                            <div><p class="font-light">Biaya Bulan Ini</p><p id="summary-biaya" class="text-2xl font-bold">Rp 0</p></div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                            <h3 class="font-semibold mb-4">Grafik Laba/Rugi (6 Bulan Terakhir)</h3>
                            <canvas id="labaRugiChart"></canvas>
                        </div>
                        <div class="space-y-6">
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="font-semibold mb-4">Informasi Singkat</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center"><span><i class="fas fa-users text-blue-500 mr-2"></i> Pelanggan/Anggota</span><span id="info-pelanggan" class="font-bold">0</span></div>
                                    <div class="flex justify-between items-center"><span><i class="fas fa-exchange-alt text-green-500 mr-2"></i> Transaksi Hari Ini</span><span id="info-transaksi" class="font-bold">0</span></div>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                                <h3 class="font-semibold mb-4">Notifikasi Penting</h3>
                                <ul id="notifikasi-list" class="space-y-2 text-sm"><li class="text-gray-500">Tidak ada notifikasi.</li></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="input-data-page" class="page hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Input Data Awal & Master</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                             <button id="btn-show-identitas" class="bg-teal-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-teal-600 transition duration-300 flex items-center justify-center"><i class="fas fa-id-card mr-2"></i>Identitas BUMDes</button>
                             <button id="btn-show-kepengurusan" class="bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-600 transition duration-300 flex items-center justify-center"><i class="fas fa-sitemap mr-2"></i>Struktur Kepengurusan</button>
                            <button id="btn-show-coa" class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition duration-300 flex items-center justify-center"><i class="fas fa-list-ol mr-2"></i>Daftar Akun (COA)</button>
                            <button id="btn-show-saldo-awal" class="bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 transition duration-300 flex items-center justify-center"><i class="fas fa-file-invoice-dollar mr-2"></i>Input Saldo Awal</button>
                            <button id="btn-show-jurnal" class="bg-green-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-green-600 transition duration-300 flex items-center justify-center"><i class="fas fa-book mr-2"></i>Input Jurnal</button>
                            <button id="btn-show-inventaris" class="bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition duration-300 flex items-center justify-center"><i class="fas fa-boxes mr-2"></i>Input Inventaris</button>
                            <button id="btn-show-shu" class="bg-yellow-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-yellow-600 transition duration-300 flex items-center justify-center"><i class="fas fa-percentage mr-2"></i>Pengaturan SHU</button>
                        </div>
                        <div id="input-data-content"><p class="text-center text-gray-500">Pilih salah satu tombol di atas untuk memulai.</p></div>
                    </div>
                </div>

                <div id="unit-usaha-page" class="page hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-2xl font-bold">Manajemen Unit Usaha</h2>
                            <button id="btn-tambah-unit" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 transition duration-300"><i class="fas fa-plus mr-2"></i>Tambah Unit</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-3">Nama Unit Usaha</th><th class="p-3">Deskripsi</th><th class="p-3">Aksi</th></tr></thead><tbody id="unit-usaha-table-body"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="laporan-page" class="page hidden">
                     <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Laporan & Cetak</h2>
                        <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mb-6">
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="profil-bumdes">Profil BUMDes</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="kwitansi">Cetak Kwitansi</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="buku-besar">Buku Besar</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="neraca-saldo">Neraca Saldo</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="laba-rugi">Laba Rugi</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="posisi-keuangan">Posisi Keuangan</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="arus-kas">Arus Kas</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="shu">Perhitungan SHU</button>
                            <button class="btn-laporan bg-gray-200 dark:bg-gray-700 p-3 rounded-lg hover:bg-[var(--color-primary-start)] hover:text-white" data-report="inventaris">Daftar Inventaris</button>
                        </div>
                        <div id="laporan-controls" class="flex flex-wrap items-center gap-4 mb-4"></div>
                        <div id="laporan-content" class="border dark:border-gray-700 rounded-lg p-4 min-h-[300px]"><p class="text-center text-gray-500">Pilih jenis laporan untuk ditampilkan.</p></div>
                    </div>
                </div>

                <div id="administrasi-page" class="page hidden">
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                        <h2 class="text-2xl font-bold mb-4">Administrasi & Legalitas</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Dokumen Legalitas</h3>
                                <form id="form-upload-dokumen" class="space-y-3">
                                    <select id="select-jenis-dokumen" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"><option value="perdes">Perdes Pendirian</option><option value="adart">AD/ART</option><option value="sk">SK Pengurus</option><option value="sertifikat">Sertifikat Badan Hukum</option></select>
                                    <input type="file" id="input-file-dokumen" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100">
                                    <button type="submit" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg hover:opacity-90 w-full">Upload Dokumen</button>
                                </form>
                                <div id="list-dokumen" class="mt-4 space-y-2"></div>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Catatan Musyawarah Desa</h3>
                                <form id="form-musyawarah" class="space-y-3">
                                    <input type="hidden" name="musyawarahId">
                                    <input type="date" name="tanggal" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required>
                                    <textarea name="hasil" rows="3" placeholder="Hasil Keputusan..." class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600" required></textarea>
                                    <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 w-full">Simpan Catatan</button>
                                </form>
                                <div id="list-musyawarah" class="mt-4 space-y-4 max-h-60 overflow-y-auto"></div>
                            </div>
                            <div class="md:col-span-2">
                                <h3 class="text-lg font-semibold mb-3 border-b pb-2">Struktur Organisasi</h3>
                                <button id="btn-tampilkan-struktur" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600"><i class="fas fa-eye mr-2"></i>Tampilkan Preview Struktur</button>
                                <div id="struktur-preview-container" class="mt-4"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pengaturan-page" class="page hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Manajemen Pengguna</h2>
                                <button id="btn-tambah-pengguna" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg hover:opacity-90"><i class="fas fa-plus mr-2"></i>Tambah</button>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-3">Username</th><th class="p-3">Peran</th><th class="p-3">Aksi</th></tr></thead><tbody id="pengguna-table-body"></tbody></table>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md space-y-6">
                            <div>
                                <h2 class="text-xl font-bold mb-2">Upload Logo BUMDes</h2>
                                <div class="flex items-center space-x-4">
                                    <img id="logo-preview" src="" class="w-20 h-20 rounded-full object-cover bg-gray-200">
                                    <input type="file" id="logo-upload" accept="image/*" class="block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-teal-50 file:text-teal-700 hover:file:bg-teal-100"/>
                                </div>
                                 <button id="btn-simpan-logo" class="mt-2 bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg hover:opacity-90">Simpan Logo</button>
                            </div>
                             <div>
                                <h2 class="text-xl font-bold mb-2">Tema Aplikasi</h2>
                                <div id="theme-selector" class="flex flex-wrap gap-3">
                                    <button data-theme="default" class="theme-btn w-12 h-12 rounded-full bg-gradient-to-br from-teal-400 to-blue-600 border-2"></button>
                                    <button data-theme="sunset" class="theme-btn w-12 h-12 rounded-full bg-gradient-to-br from-orange-400 to-rose-500 border-2"></button>
                                    <button data-theme="forest" class="theme-btn w-12 h-12 rounded-full bg-gradient-to-br from-green-400 to-emerald-600 border-2"></button>
                                    <button data-theme="ocean" class="theme-btn w-12 h-12 rounded-full bg-gradient-to-br from-blue-700 to-indigo-900 border-2"></button>
                                    <button data-theme="orchid" class="theme-btn w-12 h-12 rounded-full bg-gradient-to-br from-purple-400 to-violet-600 border-2"></button>
                                </div>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold mb-2">Data Aplikasi</h2>
                                <div class="flex space-x-4">
                                    <button id="btn-backup-data" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 flex-1"><i class="fas fa-download mr-2"></i>Backup Data</button>
                                    <label for="restore-upload" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 flex-1 text-center cursor-pointer"><i class="fas fa-upload mr-2"></i>Restore Data</label>
                                    <input type="file" id="restore-upload" class="hidden" accept=".json">
                                </div>
                            </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md md:col-span-2">
                             <h2 class="text-xl font-bold mb-4">Pengaturan Tarif Pajak</h2>
                             <form id="form-pajak" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm font-medium">PPN (%)</label>
                                    <input type="number" name="ppn" step="0.1" class="form-input mt-1" value="11">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">PPh 21 (%)</label>
                                    <input type="number" name="pph21" step="0.1" class="form-input mt-1" value="5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">PPh 22 (%)</label>
                                    <input type="number" name="pph22" step="0.1" class="form-input mt-1" value="1.5">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">PPh 23 (%)</label>
                                    <input type="number" name="pph23" step="0.1" class="form-input mt-1" value="2">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium">Pajak Lainnya (%)</label>
                                    <input type="number" name="lainnya" step="0.1" class="form-input mt-1" value="0">
                                </div>
                                <div class="md:col-span-3 text-right">
                                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">Simpan Tarif Pajak</button>
                                </div>
                             </form>
                        </div>
                    </div>
                </div>

                <div id="bantuan-page" class="page hidden">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-md">
                    <h1 class="text-3xl font-bold text-center mb-6 pb-2 border-b">Buku Panduan Aplikasi Sik-BUMDes</h1>
                    <div class="text-center p-4 my-4 border-2 border-dashed rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-500">
                        <em>[Gambar: Logo BUMDes yang modern dan profesional]</em>
                    </div>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Selamat Datang</h2>
                    <p>Selamat datang di Buku Panduan Aplikasi Sik-BUMDes. Dokumen ini akan memandu Anda langkah demi langkah dalam menggunakan seluruh fitur aplikasi, mulai dari pengaturan awal hingga pelaporan keuangan. Aplikasi ini dirancang untuk menjadi alat bantu yang lengkap, mudah digunakan, dan dapat diakses secara offline untuk mengelola administrasi dan keuangan BUMDes Anda.</p>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 1: Memulai Aplikasi</h2>
                    <h3 class="text-xl font-semibold mt-6 mb-2">1.1. Halaman Login</h3>
                    <p>Saat pertama kali membuka aplikasi, Anda akan disambut oleh halaman Login.</p>
                    <div class="text-center p-4 my-4 border-2 border-dashed rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-500">
                        <em>[Gambar: Tampilan layar login Sik-BUMDes]</em>
                    </div>
                    <p><strong class="text-red-500">Langkah-langkah:</strong></p>
                    <ol class="list-decimal list-inside space-y-2 mt-2">
                        <li>Masukkan <strong>Username</strong> dan <strong>Password</strong> Anda pada kolom yang tersedia.</li>
                        <li>Secara default, pengguna pertama adalah <strong>Username:</strong> <code>admin</code> dan <strong>Password:</strong> <code>password</code>.</li>
                        <li>Klik tombol <strong>Login</strong>.</li>
                    </ol>
                    
                    <h3 class="text-xl font-semibold mt-6 mb-2">1.2. Pengenalan Tampilan Utama</h3>
                    <p>Setelah berhasil login, Anda akan masuk ke halaman utama yang terdiri dari tiga bagian.</p>
                    <div class="text-center p-4 my-4 border-2 border-dashed rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-500">
                        <em>[Gambar: Tampilan antarmuka aplikasi utama dengan penunjuk ke sidebar, header, dan area konten]</em>
                    </div>
                    <ol class="list-decimal list-inside space-y-2 mt-2">
                        <li><strong>Sidebar (Menu Navigasi):</strong> Terletak di sebelah kiri, berisi semua menu utama untuk mengakses berbagai fitur aplikasi.</li>
                        <li><strong>Header (Bagian Atas):</strong> Menampilkan judul halaman yang sedang aktif dan informasi pengguna.</li>
                        <li><strong>Area Konten Utama:</strong> Bagian tengah yang luas tempat semua fitur akan ditampilkan.</li>
                    </ol>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 2: Dasbor Utama</h2>
                    <p>Dasbor adalah halaman pertama yang Anda lihat. Halaman ini memberikan ringkasan visual dari kondisi BUMDes Anda secara <em>real-time</em>.</p>
                    <div class="text-center p-4 my-4 border-2 border-dashed rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-500">
                        <em>[Gambar: Dasbor utama dengan kartu ringkasan dan grafik laba/rugi]</em>
                    </div>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><strong>Informasi Umum BUMDes:</strong> Menampilkan nama, alamat, dan nomor AHU BUMDes Anda.</li>
                        <li><strong>Ringkasan Keuangan:</strong> Kartu berwarna-warni yang menampilkan data kunci seperti Total Aktiva, Laba Rugi, dan lainnya.</li>
                        <li><strong>Grafik Laba/Rugi:</strong> Visualisasi keuntungan atau kerugian BUMDes selama 6 bulan terakhir.</li>
                    </ul>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 3: Pengaturan Data Awal & Master</h2>
                    <p>Ini adalah langkah paling penting sebelum Anda mulai. Semua pengaturan dasar BUMDes dilakukan di menu <strong>Input Data</strong>.</p>
                    <div class="text-center p-4 my-4 border-2 border-dashed rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-500">
                        <em>[Gambar: Halaman Input Data dengan 7 tombol fiturnya]</em>
                    </div>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><strong>Identitas BUMDes:</strong> Mengisi nama, alamat, dan sumber permodalan BUMDes.</li>
                        <li><strong>Struktur Kepengurusan:</strong> Mendata semua personel (Penasehat, Direktur, dll) dan mengunggah foto mereka.</li>
                        <li><strong>Daftar Akun (COA):</strong> Menyesuaikan daftar akun keuangan jika diperlukan.</li>
                        <li><strong>Input Saldo Awal:</strong> Memasukkan saldo neraca terakhir sebelum menggunakan aplikasi.</li>
                        <li><strong>Pengaturan SHU:</strong> Menentukan persentase alokasi pembagian Sisa Hasil Usaha.</li>
                    </ul>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 4: Transaksi Sehari-hari</h2>
                    <h3 class="text-xl font-semibold mt-6 mb-2">4.1. Input Jurnal Umum</h3>
                    <p>Gunakan menu <strong>Input Data > Input Jurnal</strong> untuk mencatat semua transaksi keuangan yang terjadi, baik pemasukan maupun pengeluaran.</p>
                    <div class="text-center p-4 my-4 border-2 border-dashed rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-500">
                        <em>[Gambar: Formulir Input Jurnal]</em>
                    </div>
                    
                    <h3 class="text-xl font-semibold mt-6 mb-2">4.2. Input Inventaris BUMDes</h3>
                    <p>Gunakan menu <strong>Input Data > Input Inventaris</strong> untuk mencatat aset tetap atau barang inventaris yang dimiliki BUMDes.</p>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 5: Mengelola Unit Usaha</h2>
                    <p>Akses menu <strong>Unit Usaha</strong> di sidebar untuk menambah, mengubah, atau menghapus unit-unit usaha yang dijalankan oleh BUMDes.</p>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 6: Laporan & Cetak</h2>
                    <p>Akses menu <strong>Laporan</strong> di sidebar untuk melihat dan mencetak semua hasil olahan data menjadi laporan keuangan yang siap disajikan. Anda bisa mengatur periode laporan dan mencetaknya lengkap dengan kop surat.</p>
                    <div class="text-center p-4 my-4 border-2 border-dashed rounded-lg bg-gray-50 dark:bg-gray-700 text-gray-500">
                        <em>[Gambar: Halaman Laporan dengan tombol-tombol pilihan laporan]</em>
                    </div>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 7: Administrasi & Legalitas</h2>
                    <p>Akses menu <strong>Administrasi</strong> untuk mengarsipkan dokumen penting (Perdes, AD/ART), mencatat hasil musyawarah, dan melihat/mencetak bagan struktur organisasi.</p>
                    
                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 8: Pengaturan Aplikasi</h2>
                    <p>Akses menu <strong>Pengaturan</strong> untuk melakukan kustomisasi aplikasi, seperti:</p>
                    <ul class="list-disc list-inside space-y-2 mt-2">
                        <li><strong>Manajemen Pengguna:</strong> Mengatur siapa saja yang bisa login.</li>
                        <li><strong>Upload Logo:</strong> Mengganti logo BUMDes untuk kop surat.</li>
                        <li><strong>Tema Aplikasi:</strong> Mengubah skema warna aplikasi.</li>
                        <li><strong>Backup & Restore Data:</strong> Fitur <strong>SANGAT PENTING</strong> untuk mengamankan dan memulihkan data Anda.</li>
                        <li><strong>Pengaturan Tarif Pajak:</strong> Menyesuaikan tarif pajak yang berlaku.</li>
                    </ul>

                    <h2 class="text-2xl font-bold mt-8 mb-4 text-[var(--color-primary-text)]">Bab 9: Bantuan</h2>
                    <p>Jika Anda masih memiliki pertanyaan setelah membaca panduan ini, jangan ragu untuk menghubungi kontak yang tersedia.</p>
        <div class="mt-8 text-center">
            <a href="https://wa.me/6281991810355?text=Halo%20Admin%20Sik-BUMDes,%20saya%20butuh%20bantuan." target="_blank" class="bg-green-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-600 transition duration-300 inline-flex items-center"><i class="fab fa-whatsapp mr-2"></i>Chat Administrator</a>
        </div>
    </div>
</div>
                  
                <footer class="text-center text-sm text-gray-500 mt-8 pb-4">
                    <p class="mb-2">Â©2025 Sinar Jaya Digital Solusi</p>
                    <div class="flex justify-center space-x-4">
                        <a href="https://www.facebook.com/" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-[var(--color-primary-text)]"><i class="fab fa-facebook"></i></a>
                        <a href="https://www.youtube.com/@daridesa007" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-[var(--color-primary-text)]"><i class="fab fa-youtube"></i></a>
                        <a href="https://www.tiktok.com/@daridesa07" target="_blank" rel="noopener noreferrer" class="text-gray-500 hover:text-[var(--color-primary-text)]"><i class="fab fa-tiktok"></i></a>
                    </div>
                </footer>
            </main>
        </div>
    </div>
    
    <div id="modal-container"></div>
    <div id="print-area" class="hidden"></div>

<script>
let isPrinting = false; // <-- TAMBAHKAN BARIS INI
window.onload = () => {

    // ===================================================================================
    // --- APP STATE & INITIALIZATION ---
    // ===================================================================================
    const CURRENT_APP_VERSION = "1.2.0"; // Versi aplikasi saat ini
    let sikBumdesData;
    let labaRugiChart;

    function startMainApp() {
        sikBumdesData = JSON.parse(localStorage.getItem('sikBumdesData'));
        if (!sikBumdesData) {
            sikBumdesData = getDefaultData();
            saveData();
        }

        // Cek versi dan tampilkan notifikasi jika perlu
        if (!sikBumdesData.version || sikBumdesData.version !== CURRENT_APP_VERSION) {
            el('#update-notification').classList.remove('hidden');
        }
        
        const savedTheme = localStorage.getItem('sikBumdesTheme') || 'default';
        applyTheme(savedTheme);

        if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            el('#theme-toggle i').classList.replace('fa-moon', 'fa-sun');
        } else {
            document.documentElement.classList.remove('dark');
            el('#theme-toggle i').classList.replace('fa-sun', 'fa-moon');
        }

        const loggedInUser = JSON.parse(sessionStorage.getItem('loggedInUser'));
        if (loggedInUser) {
            showApp();
            updateUserInfo(loggedInUser);
            navigateTo('home');
        } else {
            showLogin();
        }
    }

    function getDefaultData() {
        const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlMmU4ZjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDBweCIgZmlsbD0iIzMzMyI+PzwvdGV4dD48L3N2Zz4=';
        return {
            version: CURRENT_APP_VERSION,
            identitas: {
                nama: "BUMDes Desa Mandiri", status: "BUMDesa", ahu: "AHU-12345.AH.01.01",
                alamat: { desa: "Desa Mandiri", kec: "Kec. Sejahtera", kab: "Kab. Maju", prov: "Prov. Indonesia", jalan: "Jl. Pembangunan No. 1" },
                penasihat: { nama: "", nip: "", hp: "", alamat: "", foto: placeholderImg },
                pengelola: {
                    direktur: { nama: "John Doe", nip: "", hp: "", alamat: "", foto: placeholderImg },
                    sekretaris: { nama: "", nip: "", hp: "", alamat: "", foto: placeholderImg },
                    bendahara: { nama: "", nip: "", hp: "", alamat: "", foto: placeholderImg },
                },
                pengawas: [{ id: `pengawas_${Date.now()}`, nama: "", nip: "", hp: "", alamat: "", foto: placeholderImg }],
                ketuaUnit: [],
                pendamping: { 
                    desa: { nama: "", hp: "", alamat: "" }, 
                    lokal: { nama: "", hp: "", alamat: "" } 
                },
                modal: {
                    danaDesa: [0, 0, 0, 0, 0, 0],
                    bantuanPusat: [0, 0, 0, 0, 0, 0],
                    bantuanProvinsi: [0, 0, 0, 0, 0, 0],
                    bantuanKabupaten: [0, 0, 0, 0, 0, 0],
                    lainLain: [0, 0, 0, 0, 0, 0],
                    pades: [0, 0, 0, 0, 0, 0]
                },
                aspekPelaporan: {
                    bukuJurnal: false, bukuBesar: false, neracaSaldo: false, laporanNeraca: false,
                    laporanLabaRugi: false, laporanPerubahanModal: false, cashflow: false,
                    rapb: false, rencanaKegiatan: false, analisaUsaha: false
                }
            },
            shu: {
                bonusPengurus: 20, pendidikan: 10, danaSosial: 15, paDesa: 50, penambahanModal: 50
            },
            coa: [
                { no: '1.1.01.01', nama: 'Kas', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.1.02.01', nama: 'Bank BRI', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.1.03.02', nama: 'Piutang Usaha', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.1.05.01', nama: 'Persediaan Barang Dagang Unit Usaha 1', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.1.06.01', nama: 'PPN Masukan', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.2.01.02', nama: 'Bangunan', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.2.01.03', nama: 'Kendaraan', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.2.01.05', nama: 'Inventaris Kantor', saldoNormal: 'DEBET', kelompok: 'NERACA' },
                { no: '1.2.01.07', nama: 'Akumulasi Penyusutan Bangunan', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '1.2.01.08', nama: 'Akumulasi Penyusutan Kendaraan', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '1.2.01.10', nama: 'Akumulasi Penyusutan Inventaris Kantor', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '2.1.01.01', nama: 'Utang Usaha', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '2.1.03.01', nama: 'Utang Gaji/Upah', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '2.1.04.01', nama: 'PPN Keluaran', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '2.1.04.02', nama: 'Utang PPh 21', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '2.1.04.03', nama: 'Utang PPh 22', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '2.1.04.04', nama: 'Utang PPh 23', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '2.1.04.05', nama: 'Utang Pajak Lainnya', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '3.1.01.01', nama: 'Modal dari Desa', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '3.1.01.03', nama: 'Modal dari Masyarakat', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '3.1.02.01', nama: 'Saldo Laba ditahan', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '3.1.02.02', nama: 'Laba (Rugi) Tahun Berjalan', saldoNormal: 'KREDIT', kelompok: 'NERACA' },
                { no: '4.1.01', nama: 'Pendapatan Unit Usaha 1', saldoNormal: 'KREDIT', kelompok: 'LABA RUGI' },
                { no: '5.1.0.01', nama: 'HPP Unit Usaha 1', saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
                { no: '5.1.08.01', nama: 'Gaji & Tunjangan Pengurus', saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
                { no: '5.1.08.12', nama: 'Biaya Listrik dan PDAM', saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
                { no: '5.1.08.18', nama: 'Biaya ATK dan Fotocopy', saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
                { no: '5.1.08.34', nama: 'Biaya Penyusutan Bangunan', saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
                { no: '5.1.08.35', nama: 'Biaya Penyusutan Kendaraan', saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
                { no: '5.1.08.36', nama: 'Biaya Penyusutan Inventaris', saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
            ],
            saldoAwal: {},
            jurnal: [],
            inventaris: [],
            unitUsaha: [{ id: '1', nama: 'Unit Usaha 1', deskripsi: 'Kegiatan operasional utama BUMDes' }],
            dokumen: { perdes: null, adart: null, sk: null, sertifikat: null },
            musyawarah: [],
            pengguna: [{ username: 'admin', password: 'password', peran: 'Admin' }],
            pengaturan: { 
                logo: placeholderImg,
                pajak: { ppn: 11, pph21: 5, pph22: 1.5, pph23: 2, lainnya: 0 }
            }
        };
    }

    function saveData() {
        sikBumdesData.version = CURRENT_APP_VERSION;
        localStorage.setItem('sikBumdesData', JSON.stringify(sikBumdesData));
    }

    // ===================================================================================
    // --- UTILITIES ---
    // ===================================================================================
   function getPengurusDataByKey(key) {
        const { identitas } = sikBumdesData;
        const parts = key.split('_');
        const type = parts[0];
        const id = key;

        if (type === 'penasihat') return identitas.penasihat;
        if (['direktur', 'sekretaris', 'bendahara'].includes(type)) return identitas.pengelola[type];
        
        const dynamicList = identitas[type] || [];
        // Perbaikan: ID lengkapnya adalah type + id dari item
        const fullId = `${type}_${parts[1]}`;
        return dynamicList.find(p => `${type}_${p.id}` === fullId || p.id === fullId);
    }
    
    function printNameTag(data, title) {
    // LANGKAH 1: Mencegah dialog cetak berulang
    if (isPrinting) return;
    isPrinting = true;

    const { identitas, pengaturan } = sikBumdesData;

    // DESAIN KARTU NAMA PALING STABIL (TANPA TUMPANG TINDIH)
    const nameTagHtml = `
        <div 
            class="nametag-print-container flex flex-col" 
            style="
                font-family: sans-serif; 
                background-color: white;
                border-radius: 1rem; 
                overflow: hidden; 
                border: 1px solid #ddd; 
                color: black;
                -webkit-print-color-adjust: exact; /* Memaksa browser mencetak background */
                color-adjust: exact;
            "
        >
            
            <div 
                class="pt-3 pb-3 flex flex-col items-center text-white" 
                style="background-color: #D32F2F;" /* Warna merah solid yang lebih elegan */
            >
                <img src="${pengaturan.logo}" alt="Logo BUMDes" class="w-14 h-14 object-contain rounded-full bg-white p-1 mb-2">
                <p class="font-bold text-md leading-tight">${identitas.nama.toUpperCase()}</p>
                <p class="text-xs">${identitas.alamat.desa}, ${identitas.alamat.kec}</p>
            </div>
            
            <div class="flex-grow flex flex-col items-center text-center p-4">
                
                <img src="${data.foto}" alt="Foto Pengurus" class="w-24 h-32 object-cover rounded-md border-2 border-gray-200 shadow-md mb-3">
                
                <div>
                    <p class="font-bold text-lg">${data.nama || '[Nama Pengurus]'}</p>
                    <p class="text-gray-600 text-sm">${title}</p>
                    ${data.nip ? `<p class="text-xs text-gray-500 font-mono mt-1">NIP: ${data.nip}</p>` : ''}
                </div>
            </div>
        </div>
    `;

    const printArea = el('#print-area');
    printArea.innerHTML = nameTagHtml;
    printArea.classList.remove('hidden');

    window.print();
    
    setTimeout(() => {
        printArea.innerHTML = '';
        printArea.classList.add('hidden');
        // LANGKAH 1: Reset penanda setelah selesai
        isPrinting = false; 
    }, 500);
}
	
   const formatCurrency = (amount) => {
        if (typeof amount !== 'number' || isNaN(amount)) return 'Rp 0';
        return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
    };
    const el = (selector) => document.querySelector(selector);
    const all = (selector) => document.querySelectorAll(selector);
	
// Fungsi baru untuk membuat HTML kop surat
    function generatePrintHeaderHtml(title, period) {
        const { identitas, pengaturan } = sikBumdesData;
        // Perhatikan: Gaya CSS ditulis inline agar langsung tampil di preview layar
        return `
            <div class="print-header" style="display: flex; align-items: center; text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 20px;">
                <img src="${pengaturan.logo}" alt="Logo" style="width: 60px; height: 60px; margin-right: 15px;">
                <div class="print-header-text" style="flex-grow: 1;">
                    <h3 style="font-size: 16pt; font-weight: bold; margin: 0;">${identitas.nama.toUpperCase()}</h3>
                    <p style="font-size: 10pt; margin: 0;">${identitas.alamat.jalan}, ${identitas.alamat.desa}, ${identitas.alamat.kec}</p>
                </div>
            </div>
            <h4 class="report-title" style="font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 5px;">${title}</h4>
            ${period ? `<p class="report-period" style="font-size: 11pt; text-align: center; margin-bottom: 20px;">${period}</p>` : ''}
        `;
    }
    function terbilang(n) {
        const bilangan = ["", "satu", "dua", "tiga", "empat", "lima", "enam", "tujuh", "delapan", "sembilan", "sepuluh", "sebelas"];
        if (n < 12) return bilangan[n];
        if (n < 20) return terbilang(n - 10) + " belas";
        if (n < 100) return terbilang(Math.floor(n / 10)) + " puluh " + terbilang(n % 10);
        if (n < 200) return "seratus " + terbilang(n - 100);
        if (n < 1000) return terbilang(Math.floor(n / 100)) + " ratus " + terbilang(n % 100);
        if (n < 2000) return "seribu " + terbilang(n - 1000);
        if (n < 1000000) return terbilang(Math.floor(n / 1000)) + " ribu " + terbilang(n % 1000);
        if (n < 1000000000) return terbilang(Math.floor(n / 1000000)) + " juta " + terbilang(n % 1000000);
        return "";
    }
// ===================================================================================
    // --- FUNGSI CETAK UTAMA --- (Anda bisa menempelkan kodenya di sini)
    // ===================================================================================
    function printReportWithHeader(title, period, content, isLandscape = false, reportType = '') {
    const { identitas, pengaturan } = sikBumdesData;

    const tanggalCetak = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    const namaDesa = identitas.alamat.desa;

    let signatureHtml = '';
    
    if (reportType === 'profil-bumdes') {
        const direkturNama = identitas.pengelola.direktur.nama || '(.................................)';
        const penasihatNama = identitas.penasihat.nama || '(.................................)';
        const pengawas1Nama = identitas.pengawas.length > 0 ? identitas.pengawas[0].nama : '(.................................)';

        signatureHtml = `
            <div class="signature-section-profile">
                <div class="signature-block">
                    <p>Penasihat</p>
                    <p class="signature-name">${penasihatNama}</p>
                </div>
            </div>
            <div class="signature-section">
                <div class="signature-block">
                    <p>Perwakilan Pengawas</p>
                    <p class="signature-name">${pengawas1Nama}</p>
                </div>
                <div class="signature-block">
                    <p>${namaDesa}, ${tanggalCetak}</p>
                    <p>Direktur</p>
                    <p class="signature-name">${direkturNama}</p>
                </div>
            </div>
        `;
    } 
    else {
        const direkturNama = identitas.pengelola.direktur.nama || '(.................................)';
        const bendaharaNama = identitas.pengelola.bendahara.nama || '(.................................)';

        signatureHtml = `
            <div class="signature-section">
                <div class="signature-block">
                    <p>Bendahara</p>
                    <p class="signature-name">${bendaharaNama}</p>
                </div>
                <div class="signature-block">
                    <p>${namaDesa}, ${tanggalCetak}</p>
                    <p>Direktur</p>
                    <p class="signature-name">${direkturNama}</p>
                </div>
            </div>
        `;
    }

    // --- PERUBAHAN FINAL PADA GAYA CETAK BAGAN ---
    let dynamicPrintStyles = '';
    if (reportType === 'struktur-organisasi') {
        dynamicPrintStyles = `
            /* Menghapus jarak di bawah judul khusus untuk cetak bagan */
            .report-title, .report-period {
                margin-bottom: 5px !important;
            }
            .print-content-wrapper {
                display: flex;
                justify-content: center;
                /* Hapus semua padding dan margin atas yang mungkin menyebabkan jarak */
                padding-top: 0 !important; 
                margin-top: 0 !important;
            }
            .struktur-organisasi {
                transform: scale(0.7); /* Ukuran sedikit dikecilkan lagi agar lebih aman */
                transform-origin: top center;
                /* Hapus margin-top negatif yang tidak stabil */
            }
        `;
    }
    // --- AKHIR PERUBAHAN ---

    const printHtml = `
        <style>
            @media print {
                @page { size: ${isLandscape ? 'landscape' : 'portrait'}; margin: 0.5in; }
                body { -webkit-print-color-adjust: exact !important; color-adjust: exact !important; font-family: 'Arial', sans-serif; font-size: 10pt; }
                .print-header { display: flex; align-items: center; text-align: center; border-bottom: 2px solid black; padding-bottom: 10px; margin-bottom: 0; }
                .print-header img { width: 60px; height: 60px; margin-right: 15px; }
                .print-header-text { flex-grow: 1; }
                .print-header h3 { font-size: 16pt; font-weight: bold; margin: 0; }
                .print-header p { font-size: 10pt; margin: 0; }
                .report-title { font-size: 14pt; font-weight: bold; text-align: center; margin-bottom: 5px; }
                .report-period { font-size: 11pt; text-align: center; margin-bottom: 20px; }
                .report-table { border-collapse: collapse; width: 100%; }
                .report-table th, .report-table td { border: 1px solid #333; padding: 6px; text-align: left; }
                .report-table th { background-color: #f2f2f2 !important; font-weight: bold; }
                .signature-section { display: flex; justify-content: space-between; margin-top: 50px; page-break-inside: avoid; }
                .signature-block { text-align: center; width: 250px; }
                .signature-name { margin-top: 70px; font-weight: bold; text-decoration: underline; }
                .signature-section-profile { display: flex; justify-content: center; margin-top: 40px; margin-bottom: -20px; page-break-inside: avoid; }
                
                ${dynamicPrintStyles}
            }
        </style>
        <div class="print-header">
            <img src="${pengaturan.logo}" alt="Logo">
            <div class="print-header-text">
                <h3>${identitas.nama.toUpperCase()}</h3>
                <p>${identitas.alamat.jalan}, ${identitas.alamat.desa}, ${identitas.alamat.kec}</p>
            </div>
        </div>
        <h4 class="report-title">${title}</h4>
        ${period ? `<p class="report-period">${period}</p>` : ''}
        
        <div class="print-content-wrapper">
            ${content}
        </div>

        ${signatureHtml}
    `;

    const printArea = el('#print-area');
    printArea.innerHTML = printHtml;
    printArea.classList.remove('hidden');

    window.print();

    setTimeout(() => {
        printArea.innerHTML = '';
        printArea.classList.add('hidden');
    }, 500);
}
    // ===================================================================================
    // --- AUTHENTICATION ---
    // ===================================================================================
    function showLogin() {
        el('#login-page').style.display = 'flex';
        el('#app-wrapper').classList.add('hidden');
    }

    function showApp() {
        el('#login-page').style.display = 'none';
        el('#app-wrapper').classList.remove('hidden');
    }
    
    function updateUserInfo(user) {
        const userInfo = el('#user-info');
        userInfo.querySelector('p:first-child').textContent = user.username;
        userInfo.querySelector('p:last-child').textContent = user.peran;
    }

    // ===================================================================================
    // --- UI & NAVIGATION ---
    // ===================================================================================
    const themes = {
        default: { '--color-primary-start': '#2dd4bf', '--color-primary-end': '#3b82f6', '--color-primary-text': '#0d9488' },
        sunset: { '--color-primary-start': '#fb923c', '--color-primary-end': '#f43f5e', '--color-primary-text': '#f97316' },
        forest: { '--color-primary-start': '#4ade80', '--color-primary-end': '#059669', '--color-primary-text': '#16a34a' },
        ocean: { '--color-primary-start': '#38bdf8', '--color-primary-end': '#4338ca', '--color-primary-text': '#1d4ed8' },
        orchid: { '--color-primary-start': '#c084fc', '--color-primary-end': '#7c3aed', '--color-primary-text': '#9333ea' },
    };

    function applyTheme(themeName) {
        const theme = themes[themeName] || themes.default;
        const root = document.documentElement;
        for (const [key, value] of Object.entries(theme)) {
            root.style.setProperty(key, value);
        }
        localStorage.setItem('sikBumdesTheme', themeName);

        all('.theme-btn').forEach(btn => {
            btn.classList.remove('border-gray-800', 'dark:border-white', 'border-opacity-100');
            btn.classList.add('border-transparent');
            if (btn.dataset.theme === themeName) {
                btn.classList.remove('border-transparent');
                btn.classList.add('border-gray-800', 'dark:border-white', 'border-opacity-100');
            }
        });
    }

    function navigateTo(pageId) {
        all('.page').forEach(page => page.classList.add('hidden'));
        el(`#${pageId}-page`).classList.remove('hidden');
        
        all('.nav-link').forEach(link => link.classList.remove('active', 'bg-[var(--color-primary-start)]', 'text-white'));
        const activeLink = el(`.nav-link[href="#${pageId}"]`);
        if (activeLink) {
            activeLink.classList.add('active', 'bg-[var(--color-primary-start)]', 'text-white');
            el('#page-title').textContent = activeLink.textContent;
        }

        if (window.innerWidth < 1024) {
            el('#sidebar').classList.add('-translate-x-full');
        }

        switch (pageId) {
            case 'home': renderDashboard(); break;
            case 'unit-usaha': renderUnitUsahaTable(); break;
            case 'administrasi': renderDokumenList(); renderMusyawarahList(); break;
            case 'pengaturan': renderPenggunaTable(); loadPengaturan(); break;
        }
    }

    // ===================================================================================
    // --- MODALS & NOTIFICATIONS ---
    // ===================================================================================
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `fixed top-5 right-5 p-4 rounded-lg shadow-lg text-white z-[101] transition-transform transform translate-x-full ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => { notification.classList.remove('translate-x-full'); }, 100);
        setTimeout(() => {
            notification.classList.add('translate-x-full');
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }
    
    function showConfirmationModal(message, onConfirm) {
        const modalId = `confirm-modal-${Date.now()}`;
        const modalHtml = `
            <div id="${modalId}" class="modal show fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-[100]">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-sm shadow-xl">
                    <p class="text-lg mb-4">${message}</p>
                    <div class="flex justify-end space-x-4">
                        <button class="btn-cancel bg-gray-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-600">Batal</button>
                        <button class="btn-confirm bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600">Yakin</button>
                    </div>
                </div>
            </div>`;
        el('#modal-container').insertAdjacentHTML('beforeend', modalHtml);

        const modalElement = el(`#${modalId}`);
        modalElement.querySelector('.btn-confirm').addEventListener('click', () => {
            onConfirm();
            modalElement.remove();
        });
        modalElement.querySelector('.btn-cancel').addEventListener('click', () => {
            modalElement.remove();
        });
    }

    function closeModal(modalId) {
        const modal = el(`#${modalId}`);
        if (modal) modal.remove();
    }

    // ===================================================================================
    // --- REPORTING ENGINE ---
    // ===================================================================================
    function getJurnalWithSaldoAwal() {
        const saldoAwalJurnal = [];
        const coaMap = new Map(sikBumdesData.coa.map(a => [a.no, a]));

        for (const akunNo in sikBumdesData.saldoAwal) {
            const amount = sikBumdesData.saldoAwal[akunNo];
            if (amount > 0) {
                const akun = coaMap.get(akunNo);
                if (akun) {
                    const entry = {
                        id: `sa_${akunNo}`,
                        tanggal: '1970-01-01',
                        bukti: 'SALDO AWAL',
                        keterangan: 'Saldo Awal',
                        akunNo: akunNo,
                        debit: 0,
                        credit: 0
                    };
                    if (akun.saldoNormal === 'DEBET') {
                        entry.debit = amount;
                    } else {
                        entry.credit = amount;
                    }
                    saldoAwalJurnal.push(entry);
                }
            }
        }
        return [...saldoAwalJurnal, ...sikBumdesData.jurnal];
    }

    function calculateLedger(jurnalData, coaData, toDate = null) {
        const ledger = {};
        coaData.forEach(akun => {
            ledger[akun.no] = { debit: 0, credit: 0, balance: 0, ...akun };
        });

        const filteredJurnal = toDate ? jurnalData.filter(j => new Date(j.tanggal) <= new Date(toDate)) : jurnalData;

        filteredJurnal.forEach(entry => {
            if (ledger[entry.akunNo]) {
                ledger[entry.akunNo].debit += entry.debit;
                ledger[entry.akunNo].credit += entry.credit;
            }
        });

        for (const akunNo in ledger) {
            const akun = ledger[akunNo];
            const { debit, credit, saldoNormal } = akun;
            if (saldoNormal === 'DEBET') {
                akun.balance = debit - credit;
            } else { // KREDIT
                akun.balance = credit - debit;
            }
        }
        return { ledger };
    }

    function calculateLabaRugiPeriod(startDate, endDate) {
        const allJurnal = getJurnalWithSaldoAwal();
        const { ledger: endLedger } = calculateLedger(allJurnal, sikBumdesData.coa, endDate);
        const { ledger: startLedger } = calculateLedger(allJurnal, sikBumdesData.coa, new Date(new Date(startDate) - 1).toISOString().slice(0,10));
        
        let labaRugi = 0;
        sikBumdesData.coa.filter(a => a.kelompok === 'LABA RUGI').forEach(akun => {
            const endBalance = endLedger[akun.no]?.balance || 0;
            const startBalance = startLedger[akun.no]?.balance || 0;
            const change = endBalance - startBalance;
            
            if (akun.saldoNormal === 'KREDIT') { // Pendapatan
                labaRugi += change;
            } else { // Biaya
                labaRugi -= change;
            }
        });
        return labaRugi;
    }

    // ===================================================================================
    // --- DASHBOARD MODULE ---
    // ===================================================================================
    function renderDashboard() {
        const { identitas, pengaturan, jurnal, coa } = sikBumdesData;
        el('#dashboard-logo').src = pengaturan.logo;
        el('#dashboard-nama-bumdes').textContent = identitas.nama;
        el('#dashboard-alamat').textContent = identitas.alamat ? `${identitas.alamat.jalan}, ${identitas.alamat.desa}` : 'Alamat BUMDes';
        el('#dashboard-ahu').textContent = `Nomor AHU: ${identitas.ahu || '-'}`;

        const now = new Date();
        const firstDayOfYear = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
        const today = now.toISOString().slice(0,10);

        const allJurnal = getJurnalWithSaldoAwal();
        const { ledger } = calculateLedger(allJurnal, coa, today);
        const labaRugiYTD = calculateLabaRugiPeriod(firstDayOfYear, today);
        
        let totalAktiva = 0;
        let totalPasiva = 0;
        Object.values(ledger).forEach(akun => {
            if (akun.kelompok === 'NERACA') {
                if (akun.no.startsWith('1')) totalAktiva += akun.balance;
                if (akun.no.startsWith('2') || akun.no.startsWith('3')) totalPasiva += akun.balance;
            }
        });

        const { pendapatan, biaya } = calculateMonthlyTotals(jurnal, coa, now.getFullYear(), now.getMonth());

        el('#summary-aktiva').textContent = formatCurrency(totalAktiva);
        el('#summary-pasiva').textContent = formatCurrency(totalPasiva + labaRugiYTD);
        el('#summary-modal-desa').textContent = formatCurrency(ledger['3.1.01.01']?.balance || 0);
        el('#summary-laba-rugi').textContent = formatCurrency(labaRugiYTD);
        el('#summary-pendapatan').textContent = formatCurrency(pendapatan);
        el('#summary-biaya').textContent = formatCurrency(biaya);
        
        const todayStr = new Date().toISOString().slice(0, 10);
        const transaksiHariIni = jurnal.filter(j => j.tanggal === todayStr).reduce((acc, curr) => acc.add(curr.bukti), new Set()).size;
        el('#info-transaksi').textContent = transaksiHariIni;

        renderLabaRugiChart();
    }

    function calculateMonthlyTotals(jurnalData, coaData, year, month) {
        let pendapatan = 0, biaya = 0;
        const coaMap = new Map(coaData.map(a => [a.no, a]));

        jurnalData.forEach(j => {
            const jDate = new Date(j.tanggal);
            if (jDate.getFullYear() === year && jDate.getMonth() === month) {
                const akun = coaMap.get(j.akunNo);
                if (akun && akun.kelompok === 'LABA RUGI') {
                    if (akun.saldoNormal === 'KREDIT') { // Pendapatan
                        pendapatan += j.credit - j.debit;
                    } else { // Biaya
                        biaya += j.debit - j.credit;
                    }
                }
            }
        });
        return { pendapatan, biaya };
    }

    function renderLabaRugiChart() {
        if (typeof Chart === 'undefined') {
            el('#labaRugiChart').parentElement.innerHTML = '<p class="text-center text-red-500">Gagal memuat grafik. Periksa koneksi internet Anda.</p>';
            return;
        }
        const ctx = el('#labaRugiChart').getContext('2d');
        const labels = [], labaData = [], rugiData = [];
        const now = new Date();
        for (let i = 5; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            labels.push(d.toLocaleString('id-ID', { month: 'short' }));
            const { pendapatan, biaya } = calculateMonthlyTotals(sikBumdesData.jurnal, sikBumdesData.coa, d.getFullYear(), d.getMonth());
            const labaRugi = pendapatan - biaya;
            labaData.push(labaRugi > 0 ? labaRugi : 0);
            rugiData.push(labaRugi < 0 ? -labaRugi : 0);
        }

        if (labaRugiChart) labaRugiChart.destroy();
        labaRugiChart = new Chart(ctx, {
            type: 'bar',
            data: { labels, datasets: [{ label: 'Laba', data: labaData, backgroundColor: 'rgba(75, 192, 192, 0.6)' }, { label: 'Rugi', data: rugiData, backgroundColor: 'rgba(255, 99, 132, 0.6)' }] },
            options: { responsive: true, scales: { x: { stacked: true }, y: { stacked: true, ticks: { callback: value => formatCurrency(value) } } }, plugins: { tooltip: { callbacks: { label: context => `${context.dataset.label}: ${formatCurrency(context.parsed.y)}` } } } }
        });
    }

    // ===================================================================================
    // --- INPUT DATA & MASTER MODULE ---
    // ===================================================================================
    const inputDataContent = el('#input-data-content');

    function showIdentitasForm() {
        const { identitas } = sikBumdesData;
        const currentYear = new Date().getFullYear();
        const years = Array.from({length: 6}, (_, i) => currentYear - 3 + i);

        let modalTableRows = '';
        const modalSources = [
            { key: 'danaDesa', label: 'Dana Desa' },
            { key: 'bantuanPusat', label: 'Bantuan Pemerintah Pusat' },
            { key: 'bantuanProvinsi', label: 'Bantuan Pemerintah Provinsi' },
            { key: 'bantuanKabupaten', label: 'Bantuan Pemerintah Kabupaten' },
            { key: 'lainLain', label: 'Bantuan lain (CSR dan Hibah lainnya)' },
            { key: 'pades', label: 'PADES' },
        ];
        modalSources.forEach(source => {
            modalTableRows += `<tr><td class="p-2 border">${source.label}</td>`;
            years.forEach((year, index) => {
                modalTableRows += `<td class="p-2 border"><input type="number" name="${source.key}_${index}" value="${identitas.modal[source.key][index] || 0}" class="w-full p-1 text-right"></td>`;
            });
            modalTableRows += `</tr>`;
        });

        const formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Identitas BUMDes</h3>
            <form id="form-identitas" class="space-y-6">
                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Data Umum</legend>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="block">Nama BUMDes</label><input type="text" name="nama" value="${identitas.nama || ''}" class="form-input"></div>
                        <div><label class="block">No. AHU</label><input type="text" name="ahu" value="${identitas.ahu || ''}" class="form-input"></div>
                        <div><label class="block">Alamat Jalan</label><input type="text" name="jalan" value="${identitas.alamat.jalan || ''}" class="form-input"></div>
                        <div><label class="block">Desa/Kelurahan</label><input type="text" name="desa" value="${identitas.alamat.desa || ''}" class="form-input"></div>
                        <div><label class="block">Kecamatan</label><input type="text" name="kec" value="${identitas.alamat.kec || ''}" class="form-input"></div>
                        <div><label class="block">Kabupaten/Kota</label><input type="text" name="kab" value="${identitas.alamat.kab || ''}" class="form-input"></div>
                    </div>
                </fieldset>

                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Sumber Permodalan</legend>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left">
                            <thead><tr><th class="p-2 border">Jenis Dana</th>${years.map(y => `<th class="p-2 border text-center">${y}</th>`).join('')}</tr></thead>
                            <tbody>${modalTableRows}</tbody>
                        </table>
                    </div>
                </fieldset>

                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Aspek Pelaporan</legend>
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="flex items-center"><input type="checkbox" id="bukuJurnal" name="bukuJurnal" class="mr-2" ${identitas.aspekPelaporan.bukuJurnal ? 'checked' : ''}><label for="bukuJurnal">Buku Jurnal</label></div>
                        <div class="flex items-center"><input type="checkbox" id="bukuBesar" name="bukuBesar" class="mr-2" ${identitas.aspekPelaporan.bukuBesar ? 'checked' : ''}><label for="bukuBesar">Buku Besar</label></div>
                        <div class="flex items-center"><input type="checkbox" id="neracaSaldo" name="neracaSaldo" class="mr-2" ${identitas.aspekPelaporan.neracaSaldo ? 'checked' : ''}><label for="neracaSaldo">Neraca Saldo</label></div>
                        <div class="flex items-center"><input type="checkbox" id="laporanNeraca" name="laporanNeraca" class="mr-2" ${identitas.aspekPelaporan.laporanNeraca ? 'checked' : ''}><label for="laporanNeraca">Laporan Neraca</label></div>
                        <div class="flex items-center"><input type="checkbox" id="laporanLabaRugi" name="laporanLabaRugi" class="mr-2" ${identitas.aspekPelaporan.laporanLabaRugi ? 'checked' : ''}><label for="laporanLabaRugi">Laporan Laba Rugi</label></div>
                        <div class="flex items-center"><input type="checkbox" id="laporanPerubahanModal" name="laporanPerubahanModal" class="mr-2" ${identitas.aspekPelaporan.laporanPerubahanModal ? 'checked' : ''}><label for="laporanPerubahanModal">Laporan Perubahan Modal</label></div>
                        <div class="flex items-center"><input type="checkbox" id="cashflow" name="cashflow" class="mr-2" ${identitas.aspekPelaporan.cashflow ? 'checked' : ''}><label for="cashflow">Cashflow</label></div>
                        <div class="flex items-center"><input type="checkbox" id="rapb" name="rapb" class="mr-2" ${identitas.aspekPelaporan.rapb ? 'checked' : ''}><label for="rapb">RAPB</label></div>
                        <div class="flex items-center"><input type="checkbox" id="rencanaKegiatan" name="rencanaKegiatan" class="mr-2" ${identitas.aspekPelaporan.rencanaKegiatan ? 'checked' : ''}><label for="rencanaKegiatan">Rencana Kegiatan</label></div>
                        <div class="flex items-center"><input type="checkbox" id="analisaUsaha" name="analisaUsaha" class="mr-2" ${identitas.aspekPelaporan.analisaUsaha ? 'checked' : ''}><label for="analisaUsaha">Analisa Usaha</label></div>
                    </div>
                </fieldset>

                 <div class="text-right">
                    <button type="submit" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-6 rounded-lg hover:opacity-90">Simpan Perubahan</button>
                </div>
            </form>
        `;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"');
        
        el('#form-identitas').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const id = sikBumdesData.identitas;
            id.nama = form.nama.value;
            id.ahu = form.ahu.value;
            id.alamat = { jalan: form.jalan.value, desa: form.desa.value, kec: form.kec.value, kab: form.kab.value };
            
            modalSources.forEach(source => {
                years.forEach((year, index) => {
                    id.modal[source.key][index] = parseFloat(form[`${source.key}_${index}`].value) || 0;
                });
            });

            for (const key in id.aspekPelaporan) {
                id.aspekPelaporan[key] = form[key].checked;
            }

            saveData();
            showNotification('Data identitas BUMDes berhasil diperbarui!');
            renderDashboard();
        });
    }

    function showKepengurusanForm() {
        const { identitas } = sikBumdesData;
        const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlMmU4ZjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDBweCIgZmlsbD0iIzMzMyI+PzwvdGV4dD48L3N2Zz4=';
        
        const createPengurusCard = (title, data, key) => `
            <div class="p-4 border rounded-lg dark:border-gray-600">
                <h5 class="font-semibold text-lg mb-3">${title}</h5>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-shrink-0">
                        <img id="foto-preview-${key}" src="${data.foto || placeholderImg}" class="w-16 h-16 rounded-full object-cover bg-gray-200">
                        <label for="foto-upload-${key}" class="cursor-pointer text-sm text-blue-500 hover:underline mt-2 block text-center">Ubah Foto</label>
                        <input type="file" id="foto-upload-${key}" class="hidden" accept="image/*" data-key="${key}">
                    </div>
                    <div class="flex-grow space-y-2 w-full">
                        <div><label class="block text-sm">Nama</label><input type="text" id="nama-${key}" value="${data.nama || ''}" class="form-input"></div>
                        <div><label class="block text-sm">NIP</label><input type="text" id="nip-${key}" value="${data.nip || ''}" class="form-input"></div>
                        <div><label class="block text-sm">No. HP</label><input type="text" id="hp-${key}" value="${data.hp || ''}" class="form-input"></div>
                        <div><label class="block text-sm">Alamat</label><input type="text" id="alamat-${key}" value="${data.alamat || ''}" class="form-input"></div>
                    </div>
                     <button type="button" class="btn-print-nametag text-gray-500 hover:text-blue-500" data-key="${key}" data-title="${title}"><i class="fas fa-id-card fa-2x"></i></button>
                </div>
            </div>
        `;

        let formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Struktur Kepengurusan</h3>
            <form id="form-kepengurusan" class="space-y-6">
                ${createPengurusCard('Penasehat (Kepala Desa)', identitas.penasihat, 'penasihat')}
                
                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Pengelola Operasional</legend>
                    <div class="space-y-4">
                        ${createPengurusCard('Direktur', identitas.pengelola.direktur, 'direktur')}
                        ${createPengurusCard('Sekretaris', identitas.pengelola.sekretaris, 'sekretaris')}
                        ${createPengurusCard('Bendahara', identitas.pengelola.bendahara, 'bendahara')}
                    </div>
                </fieldset>
                
                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Pengawas</legend>
                    <div id="pengawas-container" class="space-y-4"></div>
                    <button type="button" id="btn-tambah-pengawas" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm"><i class="fas fa-plus mr-2"></i>Tambah Pengawas</button>
                </fieldset>

                <fieldset class="p-4 border rounded-lg dark:border-gray-600">
                    <legend class="font-bold px-2">Ketua Unit</legend>
                    <div id="ketua-unit-container" class="space-y-4"></div>
                    <button type="button" id="btn-tambah-ketua-unit" class="mt-4 bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 text-sm"><i class="fas fa-plus mr-2"></i>Tambah Ketua Unit</button>
                </fieldset>
                
                <div class="text-right">
                    <button type="submit" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-6 rounded-lg hover:opacity-90">Simpan Semua Perubahan</button>
                </div>
            </form>
        `;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"');
        
        renderDynamicFields('pengawas', 'Pengawas', el('#pengawas-container'));
        renderDynamicFields('ketuaUnit', 'Ketua Unit', el('#ketua-unit-container'));

        el('#btn-tambah-pengawas').addEventListener('click', () => addDynamicField('pengawas', 'Pengawas', el('#pengawas-container')));
        el('#btn-tambah-ketua-unit').addEventListener('click', () => addDynamicField('ketuaUnit', 'Ketua Unit', el('#ketua-unit-container')));

        all('input[type="file"][id^="foto-upload-"]').forEach(input => {
            input.addEventListener('change', (e) => {
                const key = e.target.dataset.key;
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        el(`#foto-preview-${key}`).src = event.target.result;
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
        });
        
        all('.btn-print-nametag').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.currentTarget.dataset.key;
                const title = e.currentTarget.dataset.title;
                const data = getPengurusDataByKey(key);
                printNameTag(data, title);
            });
        });

        el('#form-kepengurusan').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = sikBumdesData.identitas;

            const savePengurus = (key, dataObj) => {
                dataObj.nama = el(`#nama-${key}`).value;
                dataObj.nip = el(`#nip-${key}`).value;
                dataObj.hp = el(`#hp-${key}`).value;
                dataObj.alamat = el(`#alamat-${key}`).value;
                dataObj.foto = el(`#foto-preview-${key}`).src;
            };

            savePengurus('penasihat', id.penasihat);
            savePengurus('direktur', id.pengelola.direktur);
            savePengurus('sekretaris', id.pengelola.sekretaris);
            savePengurus('bendahara', id.pengelola.bendahara);

            id.pengawas = id.pengawas.map(p => {
                savePengurus(`pengawas_${p.id}`, p);
                return p;
            });
            id.ketuaUnit = id.ketuaUnit.map(ku => {
                savePengurus(`ketuaUnit_${ku.id}`, ku);
                return ku;
            });

            saveData();
            showNotification('Data kepengurusan berhasil diperbarui!');
        });
    }

    function renderDynamicFields(type, title, container) {
        const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlMmU4ZjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDBweCIgZmlsbD0iIzMzMyI+PzwvdGV4dD48L3N2Zz4=';
        container.innerHTML = '';
        sikBumdesData.identitas[type].forEach((item, index) => {
            const key = `${type}_${item.id}`;
            const fieldset = document.createElement('div');
            fieldset.className = 'p-3 border rounded-lg dark:border-gray-600 relative';
            fieldset.innerHTML = `
                <h5 class="font-semibold mb-2">${title} ${index + 1}</h5>
                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-shrink-0">
                        <img id="foto-preview-${key}" src="${item.foto || placeholderImg}" class="w-16 h-16 rounded-full object-cover bg-gray-200">
                        <label for="foto-upload-${key}" class="cursor-pointer text-sm text-blue-500 hover:underline mt-2 block text-center">Ubah Foto</label>
                        <input type="file" id="foto-upload-${key}" class="hidden" accept="image/*" data-key="${key}">
                    </div>
                    <div class="flex-grow space-y-2 w-full">
                        <div><label class="block text-sm">Nama</label><input type="text" id="nama-${key}" value="${item.nama || ''}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"></div>
                        <div><label class="block text-sm">NIP</label><input type="text" id="nip-${key}" value="${item.nip || ''}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"></div>
                        <div><label class="block text-sm">No. HP</label><input type="text" id="hp-${key}" value="${item.hp || ''}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"></div>
                        <div><label class="block text-sm">Alamat</label><input type="text" id="alamat-${key}" value="${item.alamat || ''}" class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600 text-sm"></div>
                    </div>
                    <button type="button" class="btn-print-nametag text-gray-500 hover:text-blue-500" data-key="${key}" data-title="${title} ${index + 1}"><i class="fas fa-id-card fa-2x"></i></button>
                </div>
                <button type="button" class="btn-hapus-dinamis absolute top-2 right-2 text-red-500 hover:text-red-700" data-type="${type}" data-id="${item.id}"><i class="fas fa-times-circle"></i></button>
            `;
            container.appendChild(fieldset);
        });

        all('.btn-hapus-dinamis').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                const dataType = e.currentTarget.dataset.type;
                sikBumdesData.identitas[dataType] = sikBumdesData.identitas[dataType].filter(item => item.id !== id);
                renderDynamicFields(dataType, title, container);
            });
        });
        
        all('.btn-print-nametag').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const key = e.currentTarget.dataset.key;
                const title = e.currentTarget.dataset.title;
                const data = getPengurusDataByKey(key);
                printNameTag(data, title);
            });
        });
    }

    function addDynamicField(type, title, container) {
        const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlMmU4ZjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDBweCIgZmlsbD0iIzMzMyI+PzwvdGV4dD48L3N2Zz4=';
        if (sikBumdesData.identitas[type].length < 5) {
            sikBumdesData.identitas[type].push({ id: `${type}_${Date.now()}`, nama: "", nip: "", hp: "", alamat: "", foto: placeholderImg });
            renderDynamicFields(type, title, container);
        } else {
            showNotification(`Maksimal 5 ${title}.`, 'error');
        }
    }

    function showCoaTable() {
        const tableHtml = `<div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Daftar Akun</h3><button id="btn-tambah-akun" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg"><i class="fas fa-plus mr-2"></i>Tambah</button></div><div class="overflow-auto max-h-[500px]"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700 sticky top-0"><tr><th class="p-3">No. Akun</th><th class="p-3">Nama Akun</th><th class="p-3">Kelompok</th><th class="p-3">Saldo Normal</th><th class="p-3">Aksi</th></tr></thead><tbody id="coa-table-body"></tbody></table></div>`;
        inputDataContent.innerHTML = tableHtml;
        renderCoaTable();
        el('#btn-tambah-akun').addEventListener('click', () => showCoaModal());
    }

    function renderCoaTable() {
        const tbody = el('#coa-table-body');
        tbody.innerHTML = '';
        sikBumdesData.coa.sort((a,b) => a.no.localeCompare(b.no)).forEach((akun) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            row.innerHTML = `<td class="p-3">${akun.no}</td><td class="p-3">${akun.nama}</td><td class="p-3">${akun.kelompok}</td><td class="p-3">${akun.saldoNormal}</td><td class="p-3"><button class="btn-edit-coa text-blue-500 mr-2" data-no="${akun.no}"><i class="fas fa-edit"></i></button><button class="btn-delete-coa text-red-500" data-no="${akun.no}"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(row);
        });
        all('.btn-edit-coa').forEach(btn => btn.addEventListener('click', (e) => showCoaModal(e.currentTarget.dataset.no)));
        all('.btn-delete-coa').forEach(btn => btn.addEventListener('click', (e) => deleteCoa(e.currentTarget.dataset.no)));
    }

    function showCoaModal(akunNo = null) {
        const isEdit = akunNo !== null;
        const akun = isEdit ? sikBumdesData.coa.find(a => a.no === akunNo) : { no: '', nama: '', kelompok: 'NERACA', saldoNormal: 'DEBET' };
        const modalHtml = `<div id="coa-modal" class="modal show fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md"><h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Tambah'} Akun</h2><form id="form-coa"><div class="mb-4"><label>No. Akun</label><input type="text" name="no" value="${akun.no}" class="form-input" ${isEdit ? 'readonly' : ''} required></div><div class="mb-4"><label>Nama Akun</label><input type="text" name="nama" value="${akun.nama}" class="form-input" required></div><div class="mb-4"><label>Kelompok</label><select name="kelompok" class="form-input"><option value="NERACA" ${akun.kelompok === 'NERACA' ? 'selected' : ''}>NERACA</option><option value="LABA RUGI" ${akun.kelompok === 'LABA RUGI' ? 'selected' : ''}>LABA RUGI</option></select></div><div class="mb-4"><label>Saldo Normal</label><select name="saldoNormal" class="form-input"><option value="DEBET" ${akun.saldoNormal === 'DEBET' ? 'selected' : ''}>DEBET</option><option value="KREDIT" ${akun.saldoNormal === 'KREDIT' ? 'selected' : ''}>KREDIT</option></select></div><div class="flex justify-end space-x-4"><button type="button" id="btn-cancel-coa" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Batal</button><button type="submit" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div></form></div></div>`;
        el('#modal-container').innerHTML = modalHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        el('#form-coa').addEventListener('submit', (e) => {
            e.preventDefault();
            const newAkun = { 
                no: e.target.no.value, 
                nama: e.target.nama.value,
                kelompok: e.target.kelompok.value,
                saldoNormal: e.target.saldoNormal.value
            };
            if (isEdit) { 
                const index = sikBumdesData.coa.findIndex(a => a.no === akunNo);
                if (index > -1) sikBumdesData.coa[index] = newAkun;
            } else { 
                if (sikBumdesData.coa.some(a => a.no === newAkun.no)) {
                    showNotification('Nomor akun sudah ada!', 'error');
                    return;
                }
                sikBumdesData.coa.push(newAkun); 
            }
            saveData();
            renderCoaTable();
            closeModal('coa-modal');
        });
        el('#btn-cancel-coa').addEventListener('click', () => closeModal('coa-modal'));
    }

    function deleteCoa(akunNo) {
        showConfirmationModal('Yakin ingin menghapus akun ini?', () => {
            sikBumdesData.coa = sikBumdesData.coa.filter(a => a.no !== akunNo);
            saveData();
            renderCoaTable();
            showNotification('Akun berhasil dihapus.');
        });
    }
    
    function showJurnalForm() {
        const coaOptions = sikBumdesData.coa.sort((a,b) => a.no.localeCompare(b.no)).map(akun => `<option value="${akun.no}">${akun.no} - ${akun.nama}</option>`).join('');
        const formHtml = `<h3 class="text-xl font-semibold mb-4">Input Jurnal Umum</h3>
        <form id="form-jurnal" class="space-y-4">
            <div class="grid md:grid-cols-2 gap-4">
                <div><label>Tanggal</label><input type="date" name="tanggal" value="${new Date().toISOString().slice(0,10)}" class="form-input" required></div>
                <div><label>Kode Bantu</label><input type="text" name="bukti" class="form-input" required></div>
            </div>
            <div><label>Keterangan</label><textarea name="keterangan" rows="2" class="form-input" required></textarea></div>
            <div class="grid md:grid-cols-2 gap-6 border-t pt-4">
                <div class="space-y-2"><label class="font-semibold">Akun DEBIT</label><select name="akunDebit" class="form-input" required>${coaOptions}</select><input type="number" name="nominal" class="form-input" placeholder="Nominal" required></div>
                <div class="space-y-2"><label class="font-semibold">Akun KREDIT</label><select name="akunKredit" class="form-input" required>${coaOptions}</select><input type="number" name="nominalKredit" class="form-input bg-gray-200 dark:bg-gray-600" readonly></div>
            </div>
            <!-- PERBAIKAN: Opsi Pajak menjadi checklist -->
            <div class="border-t pt-4 space-y-3">
                <div class="flex items-center">
                    <input type="checkbox" id="kena-pajak-toggle" name="kenaPajakToggle" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500">
                    <label for="kena-pajak-toggle" class="ml-2 block text-sm text-gray-900 dark:text-gray-300">Transaksi ini dikenai Pajak</label>
                </div>
                <div id="pajak-container" class="hidden grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div class="flex items-center"><input type="checkbox" name="pajak" value="ppn" class="pajak-checkbox h-4 w-4"><label class="ml-2 text-sm">PPN</label></div>
                    <div class="flex items-center"><input type="checkbox" name="pajak" value="pph21" class="pajak-checkbox h-4 w-4"><label class="ml-2 text-sm">PPh 21</label></div>
                    <div class="flex items-center"><input type="checkbox" name="pajak" value="pph22" class="pajak-checkbox h-4 w-4"><label class="ml-2 text-sm">PPh 22</label></div>
                    <div class="flex items-center"><input type="checkbox" name="pajak" value="pph23" class="pajak-checkbox h-4 w-4"><label class="ml-2 text-sm">PPh 23</label></div>
                    <div class="flex items-center"><input type="checkbox" name="pajak" value="lainnya" class="pajak-checkbox h-4 w-4"><label class="ml-2 text-sm">Lainnya</label></div>
                </div>
            </div>
            <div class="text-right"><button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Simpan Jurnal</button></div>
        </form>
        <div class="mt-6"><h3 class="text-xl font-semibold mb-4">Jurnal Terakhir</h3><div class="overflow-x-auto"><table class="w-full text-left"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2">Tgl</th><th class="p-2">Kode Bantu</th><th class="p-2">Keterangan</th><th class="p-2">Akun</th><th class="p-2">Debit</th><th class="p-2">Kredit</th><th class="p-2">Aksi</th></tr></thead><tbody id="jurnal-table-body"></tbody></table></div></div>`;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        const form = el('#form-jurnal');
        form.nominal.addEventListener('input', () => { form.nominalKredit.value = form.nominal.value; });
        
        el('#kena-pajak-toggle').addEventListener('change', (e) => {
            el('#pajak-container').classList.toggle('hidden', !e.target.checked);
        });

        renderJurnalTable();
        form.addEventListener('submit', saveJurnal);
    }
    
    function saveJurnal(e) {
        e.preventDefault();
        const form = e.target;
        const nominal = parseFloat(form.nominal.value);
        if (!nominal || nominal <= 0) return showNotification('Nominal harus lebih besar dari nol.', 'error');
        if (form.akunDebit.value === form.akunKredit.value) return showNotification('Akun Debit dan Kredit tidak boleh sama.', 'error');

        const commonData = { 
            id: Date.now().toString(), 
            tanggal: form.tanggal.value, 
            bukti: form.bukti.value, 
            keterangan: form.keterangan.value,
            pajak: []
        };

        const isPajak = form.kenaPajakToggle.checked;
        
        if (isPajak) {
            const selectedPajak = all('input[name="pajak"]:checked');
            selectedPajak.forEach(pajakInput => {
                const jenisPajak = pajakInput.value;
                const tarifPajak = sikBumdesData.pengaturan.pajak[jenisPajak];
                const jumlahPajak = (nominal * tarifPajak) / 100;
                const pajakData = { type: jenisPajak, rate: tarifPajak, amount: jumlahPajak };
                commonData.pajak.push(pajakData);
            });
        }

        sikBumdesData.jurnal.push({ ...commonData, akunNo: form.akunDebit.value, debit: nominal, credit: 0 });
        sikBumdesData.jurnal.push({ ...commonData, akunNo: form.akunKredit.value, debit: 0, credit: nominal });
        
        if (commonData.pajak.length > 0) {
            commonData.pajak.forEach(pajakData => {
                handleJurnalPajak(commonData, nominal, pajakData);
            });
        }

        saveData();
        showNotification('Jurnal berhasil disimpan!');
        form.reset();
        form.tanggal.value = new Date().toISOString().slice(0,10);
        el('#pajak-container').classList.add('hidden');
        renderJurnalTable();
    }

    function handleJurnalPajak(commonData, nominal, pajakData) {
        const { type, amount } = pajakData;
        const jurnalPajak = { ...commonData, id: `${commonData.id}_pajak_${type}` }; // ID unik untuk jurnal pajak

        switch (type) {
            case 'ppn':
                const akunKreditJurnal = sikBumdesData.jurnal.find(j => j.id === commonData.id && j.credit > 0);
                const akunKreditInfo = sikBumdesData.coa.find(c => c.no === akunKreditJurnal.akunNo);
                
                if (akunKreditInfo && akunKreditInfo.no.startsWith('4')) { // Penjualan (Kredit Pendapatan)
                    sikBumdesData.jurnal.push({ ...jurnalPajak, akunNo: '2.1.04.01', debit: 0, credit: amount, keterangan: `PPN atas ${commonData.keterangan}` });
                } else { // Pembelian (Kredit Kas/Bank)
                    sikBumdesData.jurnal.push({ ...jurnalPajak, akunNo: '1.1.06.01', debit: amount, credit: 0, keterangan: `PPN atas ${commonData.keterangan}` });
                }
                break;
            case 'pph21':
                sikBumdesData.jurnal.push({ ...jurnalPajak, akunNo: '2.1.04.02', debit: 0, credit: amount, keterangan: `PPh 21 atas ${commonData.keterangan}` });
                break;
            case 'pph22':
                 sikBumdesData.jurnal.push({ ...jurnalPajak, akunNo: '2.1.04.03', debit: 0, credit: amount, keterangan: `PPh 22 atas ${commonData.keterangan}` });
                 break;
            case 'pph23':
                 sikBumdesData.jurnal.push({ ...jurnalPajak, akunNo: '2.1.04.04', debit: 0, credit: amount, keterangan: `PPh 23 atas ${commonData.keterangan}` });
                 break;
            case 'lainnya':
                 sikBumdesData.jurnal.push({ ...jurnalPajak, akunNo: '2.1.04.05', debit: 0, credit: amount, keterangan: `Pajak Lainnya atas ${commonData.keterangan}` });
                 break;
        }
    }

    function renderJurnalTable() {
        const tbody = el('#jurnal-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        const grouped = sikBumdesData.jurnal.reduce((acc, curr) => { (acc[curr.id] = acc[curr.id] || []).push(curr); return acc; }, {});
        Object.values(grouped).reverse().slice(0, 50).forEach(group => {
            group.forEach((entry, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b dark:border-gray-700';
                let firstCols = '';
                if (index === 0) {
                    firstCols = `<td rowspan="${group.length}">${entry.tanggal}</td><td rowspan="${group.length}">${entry.bukti}</td><td rowspan="${group.length}">${entry.keterangan}</td>`;
                }
                const akun = sikBumdesData.coa.find(a => a.no === entry.akunNo);
                row.innerHTML = `${firstCols}<td class="p-2">${akun ? akun.nama : 'N/A'}</td><td class="p-2 text-right">${entry.debit > 0 ? formatCurrency(entry.debit) : ''}</td><td class="p-2 text-right">${entry.credit > 0 ? formatCurrency(entry.credit) : ''}</td>${index === 0 ? `<td rowspan="${group.length}"><button class="btn-delete-jurnal text-red-500" data-id="${entry.id}"><i class="fas fa-trash"></i></button></td>` : ''}`;
                tbody.appendChild(row);
            });
        });
        all('.btn-delete-jurnal').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id;
                showConfirmationModal('Yakin ingin menghapus entri jurnal ini?', () => {
                    sikBumdesData.jurnal = sikBumdesData.jurnal.filter(j => j.id !== id);
                    saveData();
                    renderJurnalTable();
                    showNotification('Jurnal berhasil dihapus.');
                });
            });
        });
    }

    function showInventarisForm() {
        const formHtml = `<h3 class="text-xl font-semibold mb-4 border-b pb-2">Input Inventaris</h3><form id="form-inventaris" class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg space-y-4 mb-6"><input type="hidden" name="id"><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block">Nama Barang</label><input type="text" name="nama" class="form-input" required></div><div><label class="block">Tanggal Beli</label><input type="date" name="tanggalBeli" class="form-input" required></div><div><label class="block">Harga Perolehan</label><input type="number" name="harga" class="form-input" required></div></div><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><div><label class="block">Jumlah</label><input type="number" name="jumlah" value="1" class="form-input" required></div><div><label class="block">Umur Ekonomis (Tahun)</label><input type="number" name="umurEkonomis" class="form-input" required></div></div><div class="text-right"><button type="submit" class="bg-green-500 text-white font-bold py-2 px-4 rounded-lg">Simpan Inventaris</button></div></form><div class="mt-6"><h3 class="text-xl font-semibold mb-4">Data Inventaris</h3><div class="overflow-x-auto"><table class="w-full text-left text-sm"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2">Nama</th><th class="p-2">Tgl Beli</th><th class="p-2">Harga</th><th class="p-2">Umur</th><th class="p-2">Penyusutan/Thn</th><th class="p-2">Akum. Penyusutan</th><th class="p-2">Nilai Buku</th><th class="p-2">Aksi</th></tr></thead><tbody id="inventaris-table-body"></tbody></table></div></div>`;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        renderInventarisTable();
        el('#form-inventaris').addEventListener('submit', saveInventaris);
    }

    function renderInventarisTable() {
        const tbody = el('#inventaris-table-body');
        if (!tbody) return;
        tbody.innerHTML = '';
        sikBumdesData.inventaris.forEach((item, index) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            const harga = parseFloat(item.harga);
            const umur = parseFloat(item.umurEkonomis);
            const penyusutanPerTahun = umur > 0 ? harga / umur : 0;
            const tglBeli = new Date(item.tanggalBeli);
            const today = new Date();
            const yearsDiff = (today - tglBeli) / (1000 * 60 * 60 * 24 * 365.25);
            const yearsOwned = Math.max(0, Math.min(yearsDiff, umur));
            const akumulasiPenyusutan = penyusutanPerTahun * yearsOwned;
            const nilaiBuku = harga - akumulasiPenyusutan;
            row.innerHTML = `<td class="p-2">${item.nama}</td><td class="p-2">${item.tanggalBeli}</td><td class="p-2 text-right">${formatCurrency(harga)}</td><td class="p-2 text-center">${item.umurEkonomis} thn</td><td class="p-2 text-right">${formatCurrency(penyusutanPerTahun)}</td><td class="p-2 text-right">${formatCurrency(akumulasiPenyusutan)}</td><td class="p-2 text-right font-semibold">${formatCurrency(nilaiBuku)}</td><td class="p-2"><button class="btn-edit-inventaris text-blue-500 mr-2" data-index="${index}"><i class="fas fa-edit"></i></button><button class="btn-delete-inventaris text-red-500" data-index="${index}"><i class="fas fa-trash"></i></button></td>`;
            tbody.appendChild(row);
        });
        all('.btn-edit-inventaris').forEach(btn => btn.addEventListener('click', (e) => {
            const index = e.currentTarget.dataset.index;
            const item = sikBumdesData.inventaris[index];
            const form = el('#form-inventaris');
            form.id.value = item.id;
            form.nama.value = item.nama;
            form.tanggalBeli.value = item.tanggalBeli;
            form.harga.value = item.harga;
            form.jumlah.value = item.jumlah;
            form.umurEkonomis.value = item.umurEkonomis;
        }));
        all('.btn-delete-inventaris').forEach(btn => btn.addEventListener('click', (e) => {
            const index = e.currentTarget.dataset.index;
            showConfirmationModal('Yakin ingin menghapus item inventaris ini?', () => {
                sikBumdesData.inventaris.splice(index, 1);
                saveData();
                renderInventarisTable();
                showNotification('Inventaris berhasil dihapus.');
            });
        }));
    }

    function saveInventaris(e) {
        e.preventDefault();
        const form = e.target;
        const id = form.id.value;
        const newItem = {
            id: id || `inv_${Date.now()}`,
            nama: form.nama.value,
            tanggalBeli: form.tanggalBeli.value,
            harga: parseFloat(form.harga.value),
            jumlah: parseInt(form.jumlah.value),
            umurEkonomis: parseFloat(form.umurEkonomis.value)
        };
        if (id) {
            const index = sikBumdesData.inventaris.findIndex(item => item.id === id);
            sikBumdesData.inventaris[index] = newItem;
        } else {
            sikBumdesData.inventaris.push(newItem);
        }
        saveData();
        renderInventarisTable();
        form.reset();
        form.id.value = '';
    }

    function showShuForm() {
        const { shu } = sikBumdesData;
        const formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Pengaturan Persentase Sisa Hasil Usaha (SHU)</h3>
            <form id="form-shu" class="space-y-4 max-w-lg mx-auto">
                <div>
                    <label class="block mb-1">Bonus Tahunan Perangkat BUM Desa (%)</label>
                    <input type="number" name="bonusPengurus" value="${shu.bonusPengurus || 0}" class="form-input">
                </div>
                <div>
                    <label class="block mb-1">Pendidikan (Capacity Building) (%)</label>
                    <input type="number" name="pendidikan" value="${shu.pendidikan || 0}" class="form-input">
                </div>
                <div>
                    <label class="block mb-1">Dana Sosial/CSR/TJSL/RTM (%)</label>
                    <input type="number" name="danaSosial" value="${shu.danaSosial || 0}" class="form-input">
                </div>
                <hr class="my-6">
                <p class="text-sm text-gray-500">Persentase berikut dihitung dari sisa SHU setelah dikurangi alokasi di atas.</p>
                <div>
                    <label class="block mb-1">Pendapatan Asli Desa (PA Desa) (%)</label>
                    <input type="number" name="paDesa" value="${shu.paDesa || 0}" class="form-input">
                </div>
                <div>
                    <label class="block mb-1">Surplus ditahan/Penambahan Modal (%)</label>
                    <input type="number" name="penambahanModal" value="${shu.penambahanModal || 0}" class="form-input">
                </div>
                <div class="text-right pt-4">
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">Simpan Pengaturan</button>
                </div>
            </form>
        `;
        inputDataContent.innerHTML = formHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        el('#form-shu').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            sikBumdesData.shu = {
                bonusPengurus: parseFloat(form.bonusPengurus.value),
                pendidikan: parseFloat(form.pendidikan.value),
                danaSosial: parseFloat(form.danaSosial.value),
                paDesa: parseFloat(form.paDesa.value),
                penambahanModal: parseFloat(form.penambahanModal.value),
            };
            saveData();
            showNotification('Pengaturan SHU berhasil disimpan!');
        });
    }
    
    function showSaldoAwalForm() {
        const { coa, saldoAwal } = sikBumdesData;
        let rows = '';
        coa.filter(a => a.kelompok === 'NERACA').sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            rows += `
                <tr class="border-b dark:border-gray-700">
                    <td class="p-2">${akun.no}</td>
                    <td class="p-2">${akun.nama}</td>
                    <td class="p-2"><input type="number" data-no="${akun.no}" value="${saldoAwal[akun.no] || 0}" class="w-full p-1 border rounded dark:bg-gray-700 dark:border-gray-600 text-right"></td>
                </tr>
            `;
        });

        const formHtml = `
            <h3 class="text-xl font-semibold mb-4 border-b pb-2">Input Saldo Awal Neraca</h3>
            <form id="form-saldo-awal">
                <div class="overflow-auto max-h-[500px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                            <tr><th class="p-2">No. Akun</th><th class="p-2">Nama Akun</th><th class="p-2">Saldo</th></tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
                <div class="text-right mt-4">
                    <button type="submit" class="bg-green-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-600">Simpan Saldo Awal</button>
                </div>
            </form>
        `;
        inputDataContent.innerHTML = formHtml;

        el('#form-saldo-awal').addEventListener('submit', (e) => {
            e.preventDefault();
            const inputs = e.target.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                const value = parseFloat(input.value);
                if (value > 0) {
                    sikBumdesData.saldoAwal[input.dataset.no] = value;
                } else {
                    delete sikBumdesData.saldoAwal[input.dataset.no];
                }
            });
            saveData();
            showNotification('Saldo awal berhasil disimpan!');
        });
    }

    // ===================================================================================
    // --- UNIT USAHA MODULE ---
    // ===================================================================================
    function renderUnitUsahaTable() {
        const tbody = el('#unit-usaha-table-body');
        tbody.innerHTML = '';
        sikBumdesData.unitUsaha.forEach((unit) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            row.innerHTML = `<td class="p-3">${unit.nama}</td><td class="p-3">${unit.deskripsi}</td><td class="p-3"><button class="btn-edit-unit text-blue-500 mr-2" data-id="${unit.id}"><i class="fas fa-edit"></i></button>${unit.id !== '1' ? `<button class="btn-delete-unit text-red-500" data-id="${unit.id}"><i class="fas fa-trash"></i></button>` : ''}</td>`;
            tbody.appendChild(row);
        });
        all('.btn-edit-unit').forEach(btn => btn.addEventListener('click', e => showUnitUsahaModal(e.currentTarget.dataset.id)));
        all('.btn-delete-unit').forEach(btn => btn.addEventListener('click', e => deleteUnitUsaha(e.currentTarget.dataset.id)));
    }
    
    function showUnitUsahaModal(unitId = null) {
        const isEdit = unitId !== null;
        const unit = isEdit ? sikBumdesData.unitUsaha.find(u => u.id === unitId) : { id: `unit_${Date.now()}`, nama: '', deskripsi: '' };
        const modalHtml = `<div id="unit-modal" class="modal show fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50"><div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md"><h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Tambah'} Unit Usaha</h2><form id="form-unit"><div class="mb-4"><label>Nama Unit</label><input type="text" name="nama" value="${unit.nama}" class="form-input" required></div><div class="mb-4"><label>Deskripsi</label><textarea name="deskripsi" rows="3" class="form-input">${unit.deskripsi}</textarea></div><div class="flex justify-end space-x-4"><button type="button" id="btn-cancel-unit" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Batal</button><button type="submit" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg">Simpan</button></div></form></div></div>`;
        el('#modal-container').innerHTML = modalHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        el('#form-unit').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const newUnit = { id: unit.id, nama: form.nama.value, deskripsi: form.deskripsi.value };
            
            if (isEdit) {
                const index = sikBumdesData.unitUsaha.findIndex(u => u.id === unitId);
                if (index > -1) sikBumdesData.unitUsaha[index] = newUnit;
            } else {
                sikBumdesData.unitUsaha.push(newUnit);
                const newAccounts = generateUnitAccounts(newUnit);
                sikBumdesData.coa.push(...newAccounts);
            }
            saveData();
            renderUnitUsahaTable();
            closeModal('unit-modal');
        });
        el('#btn-cancel-unit').addEventListener('click', () => closeModal('unit-modal'));
    }

    function deleteUnitUsaha(unitId) {
        showConfirmationModal('Yakin ingin menghapus unit usaha ini? Ini juga akan menghapus akun terkait.', () => {
            sikBumdesData.unitUsaha = sikBumdesData.unitUsaha.filter(u => u.id !== unitId);
            const unitIdentifier = `Unit Usaha ${unitId}`;
            sikBumdesData.coa = sikBumdesData.coa.filter(a => !a.nama.includes(unitIdentifier));
            saveData();
            renderUnitUsahaTable();
            showNotification('Unit usaha berhasil dihapus.');
        });
    }
    
    function generateUnitAccounts(unit) {
        const unitNumber = sikBumdesData.unitUsaha.length;
        const unitName = unit.nama;
        return [
            { no: `1.1.05.${String(unitNumber).padStart(2, '0')}`, nama: `Persediaan Barang Dagang ${unitName}`, saldoNormal: 'DEBET', kelompok: 'NERACA' },
            { no: `4.1.${String(unitNumber).padStart(2, '0')}`, nama: `Pendapatan ${unitName}`, saldoNormal: 'KREDIT', kelompok: 'LABA RUGI' },
            { no: `5.1.${String(unitNumber).padStart(2, '0')}.01`, nama: `HPP ${unitName}`, saldoNormal: 'DEBET', kelompok: 'LABA RUGI' },
        ];
    }

    // ===================================================================================
    // --- ADMINISTRASI MODULE ---
    // ===================================================================================
    function renderDokumenList() {
        const listEl = el('#list-dokumen');
        listEl.innerHTML = '';
        const { dokumen } = sikBumdesData;
        for (const key in dokumen) {
            if (dokumen[key]) {
                const doc = dokumen[key];
                const item = document.createElement('div');
                item.className = 'flex justify-between items-center p-2 bg-gray-100 dark:bg-gray-700 rounded';
                item.innerHTML = `<span><i class="fas fa-file-alt mr-2"></i>${key.toUpperCase()}: ${doc.name}</span><div><a href="${doc.data}" download="${doc.name}" class="text-blue-500 mr-3"><i class="fas fa-download"></i></a><button class="btn-delete-dokumen text-red-500" data-key="${key}"><i class="fas fa-trash"></i></button></div>`;
                listEl.appendChild(item);
            }
        }
        all('.btn-delete-dokumen').forEach(btn => btn.addEventListener('click', e => {
            const key = e.currentTarget.dataset.key;
            showConfirmationModal(`Yakin ingin menghapus dokumen ${key.toUpperCase()}?`, () => {
                sikBumdesData.dokumen[key] = null;
                saveData();
                renderDokumenList();
                showNotification('Dokumen berhasil dihapus.');
            });
        }));
    }

    function renderMusyawarahList() {
        const listEl = el('#list-musyawarah');
        listEl.innerHTML = '';
        if (sikBumdesData.musyawarah.length === 0) {
            listEl.innerHTML = '<p class="text-sm text-gray-500">Belum ada catatan musyawarah.</p>';
            return;
        }
        sikBumdesData.musyawarah.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal)).forEach(item => {
            const card = document.createElement('div');
            card.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded-lg';
            card.innerHTML = `
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-bold">${new Date(item.tanggal).toLocaleDateString('id-ID', { dateStyle: 'long' })}</p>
                        <p class="text-sm mt-1 whitespace-pre-wrap">${item.hasil}</p>
                    </div>
                    <div>
                        <button class="btn-edit-musyawarah text-blue-500 mr-2" data-id="${item.id}"><i class="fas fa-edit"></i></button>
                        <button class="btn-delete-musyawarah text-red-500" data-id="${item.id}"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
            `;
            listEl.appendChild(card);
        });

        all('.btn-edit-musyawarah').forEach(btn => btn.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            const item = sikBumdesData.musyawarah.find(m => m.id === id);
            const form = el('#form-musyawarah');
            form.musyawarahId.value = item.id;
            form.tanggal.value = item.tanggal;
            form.hasil.value = item.hasil;
        }));

        all('.btn-delete-musyawarah').forEach(btn => btn.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            showConfirmationModal('Yakin ingin menghapus catatan ini?', () => {
                sikBumdesData.musyawarah = sikBumdesData.musyawarah.filter(m => m.id !== id);
                saveData();
                renderMusyawarahList();
                showNotification('Catatan berhasil dihapus.');
            });
        }));
    }

    // ===================================================================================
    // --- LAPORAN MODULE ---
    // ===================================================================================
   function generateKwitansiUI() {
    // Mengambil data tarif pajak dari pengaturan untuk ditampilkan di label
    const { pajak } = sikBumdesData.pengaturan;

    return `
        <div class="max-w-4xl mx-auto">
            <div id="kwitansi-form-container" class="grid grid-cols-1 md:grid-cols-2 gap-6 no-print">
                <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                    <h3 class="font-semibold text-lg mb-4">Input Data Kwitansi</h3>
                    <form id="form-kwitansi" class="space-y-3">
                        <div>
                            <label class="block text-sm">No. Kwitansi (Opsional)</label>
                            <input type="text" id="kwitansi-no" class="form-input" placeholder="Contoh: 001/BUMDES/VIII/2025">
                        </div>
                        <div>
                            <label class="block text-sm">Telah Diterima Dari</label>
                            <input type="text" id="kwitansi-penerima" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm">Untuk Pembayaran</label>
                            <textarea id="kwitansi-tujuan" rows="3" class="form-input" required></textarea>
                        </div>
                        <div>
                            <label class="block text-sm">Jumlah (Rp)</label>
                            <input type="number" id="kwitansi-jumlah" class="form-input" required>
                        </div>
                        
                        <div class="border-t pt-3 space-y-2">
                            <div class="flex items-center">
                                <input type="checkbox" id="kwitansi-kena-pajak" class="h-4 w-4 rounded">
                                <label for="kwitansi-kena-pajak" class="ml-2 font-medium">Tambahkan Potongan Pajak (Opsional)</label>
                            </div>
                            <div id="kwitansi-pajak-container" class="hidden pl-4 space-y-1 text-sm">
                                <div class="flex items-center"><input type="checkbox" class="kwitansi-pajak-item" data-pajak="ppn"><label class="ml-2">PPN (${pajak.ppn}%)</label></div>
                                <div class="flex items-center"><input type="checkbox" class="kwitansi-pajak-item" data-pajak="pph21"><label class="ml-2">PPh 21 (${pajak.pph21}%)</label></div>
                                <div class="flex items-center"><input type="checkbox" class="kwitansi-pajak-item" data-pajak="pph22"><label class="ml-2">PPh 22 (${pajak.pph22}%)</label></div>
                                <div class="flex items-center"><input type="checkbox" class="kwitansi-pajak-item" data-pajak="pph23"><label class="ml-2">PPh 23 (${pajak.pph23}%)</label></div>
                            </div>
                        </div>
                        <div class="text-right pt-2">
                            <button type="submit" class="bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600">
                                <i class="fas fa-eye mr-2"></i>Tampilkan Preview & Cetak
                            </button>
                        </div>
                    </form>
                </div>
                <div id="kwitansi-preview-container">
                    <h3 class="font-semibold text-lg mb-4">Preview</h3>
                    <div id="kwitansi-preview" class="border dark:border-gray-600 rounded-lg min-h-[300px] p-4 bg-white dark:bg-gray-800">
                         <p class="text-center text-gray-500">Preview akan muncul di sini.</p>
                    </div>
                </div>
            </div>
        </div>
    `.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
}

 function addKwitansiEventListeners() {
    const form = el('#form-kwitansi');
    if (!form) return;

    // Logika untuk menampilkan/menyembunyikan pilihan pajak
    el('#kwitansi-kena-pajak').addEventListener('change', (e) => {
        el('#kwitansi-pajak-container').classList.toggle('hidden', !e.target.checked);
    });

    form.addEventListener('submit', (e) => {
        e.preventDefault();

        const { identitas, pengaturan } = sikBumdesData;
        const no = el('#kwitansi-no').value;
        const penerima = el('#kwitansi-penerima').value;
        const tujuan = el('#kwitansi-tujuan').value;
        const jumlah = parseFloat(el('#kwitansi-jumlah').value);
        const tanggal = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        
        // --- LOGIKA PERHITUNGAN PAJAK (BARU) ---
        let potonganPajak = [];
        let totalPotongan = 0;

        if (el('#kwitansi-kena-pajak').checked) {
            all('.kwitansi-pajak-item:checked').forEach(pajakCb => {
                const jenisPajak = pajakCb.dataset.pajak;
                const tarif = pengaturan.pajak[jenisPajak];
                const jumlahPotongan = (jumlah * tarif) / 100;
                
                potonganPajak.push({
                    nama: jenisPajak.toUpperCase(),
                    tarif: tarif,
                    jumlah: jumlahPotongan
                });
                totalPotongan += jumlahPotongan;
            });
        }

        const jumlahDiterima = jumlah - totalPotongan;
        // --- AKHIR LOGIKA PAJAK ---

        const jumlahTerbilang = terbilang(jumlahDiterima).replace(/\s+/g, ' ').trim().replace(/^\w/, c => c.toUpperCase()) + " rupiah";

        // Membuat baris rincian pajak untuk ditampilkan di kwitansi
        let rincianPajakHtml = '';
        if (totalPotongan > 0) {
            rincianPajakHtml += `
                <tr><td colspan="3" class="pt-2"></td></tr>
                <tr><td class="align-top" colspan="3"><b>Rincian Potongan Pajak:</b></td></tr>`;
            potonganPajak.forEach(pajak => {
                rincianPajakHtml += `
                    <tr>
                        <td class="pl-4">- ${pajak.nama} (${pajak.tarif}%)</td>
                        <td>:</td>
                        <td>(${formatCurrency(pajak.jumlah)})</td>
                    </tr>`;
            });
            rincianPajakHtml += `
                <tr>
                    <td class="pl-4 font-semibold">Total Potongan</td>
                    <td>:</td>
                    <td class="font-semibold">(${formatCurrency(totalPotongan)})</td>
                </tr>`;
        }
        
        const kwitansiHtml = `
            <div id="kwitansi-to-print" class="p-4 border border-black" style="font-family: 'Times New Roman', serif; color: black; background-color: white;">
                <div class="flex items-center pb-2 border-b-2 border-black">
                    <img src="${sikBumdesData.pengaturan.logo}" class="w-16 h-16 mr-4">
                    <div class="text-center flex-grow">
                        <h3 class="font-bold text-xl">${identitas.nama.toUpperCase()}</h3>
                        <p class="text-sm">${identitas.alamat.jalan}, ${identitas.alamat.desa}, ${identitas.alamat.kec}</p>
                    </div>
                </div>
                <h4 class="text-center font-bold text-lg mt-4 underline">K W I T A N S I</h4>
                ${no ? `<p class="text-center text-sm">No: ${no}</p>` : ''}
                <table class="w-full mt-6 text-base">
                    <tbody>
                        <tr>
                            <td width="30%" class="align-top">Telah diterima dari</td>
                            <td width="5%" class="align-top">:</td>
                            <td class="font-semibold">${penerima}</td>
                        </tr>
                        <tr>
                            <td class="align-top">Uang sejumlah</td>
                            <td class="align-top">:</td>
                            <td class="italic bg-gray-200 p-2">${jumlahTerbilang}</td>
                        </tr>
                        <tr>
                            <td class="align-top">Untuk pembayaran</td>
                            <td class="align-top">:</td>
                            <td>${tujuan}</td>
                        </tr>
                        ${rincianPajakHtml}
                    </tbody>
                </table>
                <div class="flex justify-between items-end mt-8">
                     <div class="text-lg font-bold border-2 border-black p-2 text-center">
                        Jumlah Awal: ${formatCurrency(jumlah)}
                        ${totalPotongan > 0 ? `<br><span class="font-normal text-base">Jumlah Diterima:</span> ${formatCurrency(jumlahDiterima)}` : ''}
                    </div>
                    <div class="text-center">
                        <p>${identitas.alamat.desa}, ${tanggal}</p>
                        <p class="mb-20">Bendahara,</p>
                        <p class="font-bold underline">${sikBumdesData.identitas.pengelola.bendahara.nama || '(.................................)'}</p>
                    </div>
                </div>
            </div>
        `;
        
        el('#kwitansi-preview').innerHTML = kwitansiHtml;

        showConfirmationModal("Kwitansi siap dicetak. Lanjutkan?", () => {
            const printArea = el('#print-area');
            printArea.innerHTML = el('#kwitansi-to-print').innerHTML;
            printArea.classList.remove('hidden');
            window.print();
            printArea.innerHTML = '';
            printArea.classList.add('hidden');
        });
    });
}

   function generateReport(type) {
        const contentEl = el('#laporan-content');
        const controlsEl = el('#laporan-controls');
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), 0, 1).toISOString().slice(0,10);
        const lastDay = new Date(now.getFullYear(), 11, 31).toISOString().slice(0,10);
        let controlsHtml = '';
        const dateControls = `<span id="date-range-controls"><label>Dari:</label> <input type="date" id="report-start-date" value="${firstDay}" class="form-control"> <label>Sampai:</label> <input type="date" id="report-end-date" value="${lastDay}" class="form-control"></span>`;
        const singleDateControl = `<span id="single-date-controls"><label>Per Tanggal:</label> <input type="date" id="report-end-date" value="${lastDay}" class="form-control"></span>`;
        
        controlsEl.innerHTML = ''; 
        
        switch(type) {
            case 'buku-besar':
                const coaOptions = sikBumdesData.coa.sort((a,b) => a.no.localeCompare(b.no)).map(akun => `<option value="${akun.no}">${akun.no} - ${akun.nama}</option>`).join('');
                controlsHtml += `<label>Akun:</label> <select id="report-akun-select" class="form-control">${coaOptions}</select>${dateControls}`;
                break;
            case 'posisi-keuangan': case 'neraca-saldo': case 'inventaris': case 'shu': case 'profil-bumdes':
                controlsHtml += singleDateControl;
                break;
            case 'kwitansi':
                // No date controls needed for kwitansi main view
                break;
            default:
                controlsHtml += dateControls;
        }
        if (type !== 'kwitansi') {
            controlsHtml += `<button id="btn-filter-report" class="bg-blue-500 text-white px-3 py-1 rounded">Tampilkan</button><button id="btn-print-report" class="bg-green-500 text-white px-3 py-1 rounded"><i class="fas fa-print"></i> Cetak</button>`;
        }
        controlsEl.innerHTML = controlsHtml.replace(/class="form-control"/g, 'class="p-1 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        const renderFunction = () => {
            const startDateEl = el('#report-start-date');
            const endDateEl = el('#report-end-date');
            const startDate = startDateEl ? startDateEl.value : null;
            const endDate = endDateEl ? endDateEl.value : null;

            let reportHtml = '';
            switch (type) {
                case 'laba-rugi': reportHtml = generateLabaRugi(startDate, endDate); break;
                case 'posisi-keuangan': reportHtml = generatePosisiKeuangan(endDate); break;
                case 'neraca-saldo': reportHtml = generateNeracaSaldo(endDate); break;
                case 'buku-besar': reportHtml = generateBukuBesar(el('#report-akun-select').value, startDate, endDate); break;
                case 'arus-kas': reportHtml = generateArusKas(startDate, endDate); break;
                case 'inventaris': reportHtml = generateLaporanInventaris(endDate); break;
                case 'shu': reportHtml = generateShuReport(endDate); break;
                case 'profil-bumdes': reportHtml = generateProfileBumdes(endDate); break;
                case 'kwitansi': reportHtml = generateKwitansiUI(); break;
                default: reportHtml = `<p class="text-center text-gray-500">Laporan '${type}' belum tersedia.</p>`;
            }
            contentEl.innerHTML = reportHtml;
            if (type === 'kwitansi') addKwitansiEventListeners();
        };

        if(el('#btn-filter-report')) {
            el('#btn-filter-report').addEventListener('click', renderFunction);
        }
        if(el('#btn-print-report')) {
            el('#btn-print-report').addEventListener('click', () => {
                const reportTitle = getReportTitle(type);
                const period = el('#report-start-date') ? `Periode ${el('#report-start-date').value} s/d ${el('#report-end-date').value}` : (el('#report-end-date') ? `Per Tanggal ${el('#report-end-date').value}` : '');
                printReportWithHeader(reportTitle, period, contentEl.innerHTML, type === 'struktur-organisasi', type);
            });
        }
        renderFunction();
    }

    function getReportTitle(type) {
        const titles = { 'laba-rugi': 'Laporan Laba Rugi', 'posisi-keuangan': 'Laporan Posisi Keuangan', 'neraca-saldo': 'Laporan Neraca Saldo', 'buku-besar': 'Laporan Buku Besar', 'arus-kas': 'Laporan Arus Kas', 'inventaris': 'Laporan Daftar Inventaris', 'struktur-organisasi': 'Bagan Struktur Organisasi', 'shu': 'Perhitungan Sisa Hasil Usaha (SHU)', 'profil-bumdes': 'Profil BUMDes', 'kwitansi': 'Cetak Kwitansi' };
        return titles[type] || 'Laporan';
    }

    function generateLabaRugi(startDate, endDate) {
        const allJurnal = getJurnalWithSaldoAwal();
        const { ledger: endLedger } = calculateLedger(allJurnal, sikBumdesData.coa, endDate);
        const { ledger: startLedger } = calculateLedger(allJurnal, sikBumdesData.coa, new Date(new Date(startDate) - 1).toISOString().slice(0,10));

        let html = `<table class="w-full text-sm report-table">`;
        let totalPendapatan = 0;
        let totalBiaya = 0;

        html += `<tr><td class="level-1" colspan="2">Pendapatan</td></tr>`;
        sikBumdesData.coa.filter(a => a.kelompok === 'LABA RUGI' && a.saldoNormal === 'KREDIT').sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = (endLedger[akun.no]?.balance || 0) - (startLedger[akun.no]?.balance || 0);
            if (balance !== 0) {
                html += `<tr><td class="level-2">${akun.nama}</td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
                totalPendapatan += balance;
            }
        });
        html += `<tr class="total-row"><td class="level-2">Total Pendapatan</td><td class="text-right">${formatCurrency(totalPendapatan)}</td></tr>`;

        html += `<tr><td class="level-1 pt-4" colspan="2">Biaya-biaya</td></tr>`;
        sikBumdesData.coa.filter(a => a.kelompok === 'LABA RUGI' && a.saldoNormal === 'DEBET').sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = (endLedger[akun.no]?.balance || 0) - (startLedger[akun.no]?.balance || 0);
            if (balance !== 0) {
                html += `<tr><td class="level-2">${akun.nama}</td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
                totalBiaya += balance;
            }
        });
        html += `<tr class="total-row"><td class="level-2">Total Biaya</td><td class="text-right">${formatCurrency(totalBiaya)}</td></tr>`;

        const labaRugi = totalPendapatan - totalBiaya;
        html += `<tr class="total-row mt-4"><td class="level-1">Laba (Rugi) Bersih</td><td class="text-right">${formatCurrency(labaRugi)}</td></tr>`;
        html += `</table>`;
        return html;
    }
    
    function generatePosisiKeuangan(endDate) {
        const allJurnal = getJurnalWithSaldoAwal();
        const { ledger } = calculateLedger(allJurnal, sikBumdesData.coa, endDate);
        const firstDayOfYear = new Date(endDate).getFullYear() + '-01-01';
        const labaRugiTahunBerjalan = calculateLabaRugiPeriod(firstDayOfYear, endDate);

        let html = `<table class="w-full text-sm report-table">`;
        let totalAktiva = 0, totalPasiva = 0;
        
        // AKTIVA
        html += `<tr><td class="level-1" colspan="2">AKTIVA</td></tr>`;
        sikBumdesData.coa.filter(a => a.no.startsWith('1')).sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = ledger[akun.no]?.balance || 0;
            totalAktiva += balance;
            html += `<tr><td class="level-2">${akun.nama}</td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
        });
        html += `<tr class="total-row"><td class="level-1">TOTAL AKTIVA</td><td class="text-right">${formatCurrency(totalAktiva)}</td></tr>`;

        // PASIVA (KEWAJIBAN + MODAL)
        html += `<tr><td class="level-1 pt-4" colspan="2">KEWAJIBAN DAN MODAL</td></tr>`;
        html += `<tr><td class="level-2" colspan="2">Kewajiban</td></tr>`;
        sikBumdesData.coa.filter(a => a.no.startsWith('2')).sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            const balance = ledger[akun.no]?.balance || 0;
            totalPasiva += balance;
            html += `<tr><td class="level-3">${akun.nama}</td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
        });

        html += `<tr><td class="level-2 pt-2" colspan="2">Modal</td></tr>`;
        sikBumdesData.coa.filter(a => a.no.startsWith('3')).sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            let balance = ledger[akun.no]?.balance || 0;
            if (akun.no === '3.1.02.02') { // Akun Laba Rugi Tahun Berjalan
                balance = labaRugiTahunBerjalan;
            }
            totalPasiva += balance;
            html += `<tr><td class="level-3">${akun.nama}</td><td class="text-right">${formatCurrency(balance)}</td></tr>`;
        });
        html += `<tr class="total-row"><td class="level-1">TOTAL KEWAJIBAN DAN MODAL</td><td class="text-right">${formatCurrency(totalPasiva)}</td></tr>`;

        html += `</table>`;
        return html;
    }

    function generateNeracaSaldo(endDate) {
        const allJurnal = getJurnalWithSaldoAwal();
        const { ledger } = calculateLedger(allJurnal, sikBumdesData.coa, endDate);
        let html = `<table class="w-full text-sm report-table"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2">No. Akun</th><th class="p-2">Nama Akun</th><th class="p-2 text-right">Debit</th><th class="p-2 text-right">Kredit</th></tr></thead><tbody>`;
        let totalDebit = 0;
        let totalKredit = 0;

        Object.values(ledger).sort((a,b) => a.no.localeCompare(b.no)).forEach(akun => {
            if (akun.balance !== 0) {
                let debit = 0;
                let kredit = 0;
                if (akun.saldoNormal === 'DEBET') {
                    debit = akun.balance > 0 ? akun.balance : 0;
                    kredit = akun.balance < 0 ? -akun.balance : 0;
                } else {
                    kredit = akun.balance > 0 ? akun.balance : 0;
                    debit = akun.balance < 0 ? -akun.balance : 0;
                }
                html += `<tr><td class="p-2">${akun.no}</td><td class="p-2">${akun.nama}</td><td class="p-2 text-right">${formatCurrency(debit)}</td><td class="p-2 text-right">${formatCurrency(kredit)}</td></tr>`;
                totalDebit += debit;
                totalKredit += kredit;
            }
        });

        html += `</tbody><tfoot class="font-bold border-t-2"><tr><td class="p-2" colspan="2">Total</td><td class="p-2 text-right">${formatCurrency(totalDebit)}</td><td class="p-2 text-right">${formatCurrency(totalKredit)}</td></tr></tfoot></table>`;
        return html;
    }

    function generateBukuBesar(akunNo, startDate, endDate) {
        const allJurnal = getJurnalWithSaldoAwal();
        const { ledger: prevLedger } = calculateLedger(allJurnal, sikBumdesData.coa, new Date(new Date(startDate) - 1).toISOString().slice(0,10));
        const saldoAwal = prevLedger[akunNo]?.balance || 0;
        const akun = sikBumdesData.coa.find(a => a.no === akunNo);

        let html = `<h4 class="font-bold text-lg mb-2">${akun.no} - ${akun.nama}</h4><table class="w-full text-sm report-table"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2">Tanggal</th><th class="p-2">Keterangan</th><th class="p-2">Kode Bantu</th><th class="p-2 text-right">Debit</th><th class="p-2 text-right">Kredit</th><th class="p-2 text-right">Saldo</th></tr></thead><tbody>`;
        html += `<tr><td class="p-2" colspan="5"><b>Saldo Awal</b></td><td class="p-2 text-right"><b>${formatCurrency(saldoAwal)}</b></td></tr>`;
        
        let saldoBerjalan = saldoAwal;
        const filteredJurnal = allJurnal.filter(j => j.akunNo === akunNo && j.tanggal >= startDate && j.tanggal <= endDate);
        
        filteredJurnal.forEach(j => {
            if (akun.saldoNormal === 'DEBET') {
                saldoBerjalan += j.debit - j.credit;
            } else {
                saldoBerjalan += j.credit - j.debit;
            }
            html += `<tr><td class="p-2">${j.tanggal}</td><td class="p-2">${j.keterangan}</td><td class="p-2">${j.bukti}</td><td class="p-2 text-right">${formatCurrency(j.debit)}</td><td class="p-2 text-right">${formatCurrency(j.credit)}</td><td class="p-2 text-right">${formatCurrency(saldoBerjalan)}</td></tr>`;
        });

        html += `</tbody></table>`;
        return html;
    }

    function generateArusKas(startDate, endDate) {
        const labaRugi = calculateLabaRugiPeriod(startDate, endDate);
        
        let html = `<table class="w-full text-sm report-table">`;
        html += `<tr><td class="level-1" colspan="2">Arus Kas dari Aktivitas Operasi</td></tr>`;
        html += `<tr><td class="level-2">Laba Bersih</td><td class="text-right">${formatCurrency(labaRugi)}</td></tr>`;
        html += `<tr><td class="level-2" colspan="2">Penyesuaian (Perubahan Modal Kerja, dll.)</td></tr>`;
        html += `<tr><td class="level-3 text-gray-500" colspan="2"><i>(Perhitungan terperinci memerlukan analisis jurnal kas)</i></td></tr>`;
        html += `<tr class="total-row"><td class="level-2">Kas Bersih dari Aktivitas Operasi (Estimasi)</td><td class="text-right">${formatCurrency(labaRugi)}</td></tr>`;
        html += `</table>`;
        return html;
    }
    
    function generateLaporanInventaris(endDate) {
        let html = `<table class="w-full text-sm report-table"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2">Nama</th><th class="p-2">Tgl Beli</th><th class="p-2 text-right">Harga</th><th class="p-2 text-center">Umur</th><th class="p-2 text-right">Penyusutan/Thn</th><th class="p-2 text-right">Akum. Penyusutan</th><th class="p-2 text-right">Nilai Buku</th></tr></thead><tbody>`;
        let totalHarga = 0, totalAkumulasi = 0, totalNilaiBuku = 0;
        sikBumdesData.inventaris.forEach(item => {
            const harga = parseFloat(item.harga);
            const umur = parseFloat(item.umurEkonomis);
            const penyusutanPerTahun = umur > 0 ? harga / umur : 0;
            const tglBeli = new Date(item.tanggalBeli);
            const tglLaporan = new Date(endDate);
            const yearsDiff = (tglLaporan - tglBeli) / (1000 * 60 * 60 * 24 * 365.25);
            const yearsOwned = Math.max(0, Math.min(yearsDiff, umur));
            const akumulasiPenyusutan = penyusutanPerTahun * yearsOwned;
            const nilaiBuku = harga - akumulasiPenyusutan;
            totalHarga += harga;
            totalAkumulasi += akumulasiPenyusutan;
            totalNilaiBuku += nilaiBuku;
            html += `<tr><td class="p-2">${item.nama}</td><td class="p-2">${item.tanggalBeli}</td><td class="p-2 text-right">${formatCurrency(harga)}</td><td class="p-2 text-center">${item.umurEkonomis} thn</td><td class="p-2 text-right">${formatCurrency(penyusutanPerTahun)}</td><td class="p-2 text-right">${formatCurrency(akumulasiPenyusutan)}</td><td class="p-2 text-right font-semibold">${formatCurrency(nilaiBuku)}</td></tr>`;
        });
        html += `</tbody><tfoot class="font-bold border-t-2"><tr><td class="p-2" colspan="2">Total</td><td class="p-2 text-right">${formatCurrency(totalHarga)}</td><td colspan="2"></td><td class="p-2 text-right">${formatCurrency(totalAkumulasi)}</td><td class="p-2 text-right">${formatCurrency(totalNilaiBuku)}</td></tr></tfoot></table>`;
        return html;
    }

    function generateStrukturOrganisasi() {
        const { identitas } = sikBumdesData;
        const { penasihat, pengelola, pengawas, ketuaUnit } = identitas;
        const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlMmU4ZjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc2l6ZT0iNDBweCIgZmlsbD0iIzMzMyI+PzwvdGV4dD48L3N2Zz4=';

        const masyarakatCard = `
            <div class="org-card shadow-lg bg-emerald-500 text-white border-emerald-600" style="width: 250px;">
                <div class="org-card-title bg-transparent border-b-2 border-emerald-400 pb-2 mb-2">
                    <h4 class="font-bold text-lg">MASYARAKAT</h4>
                    <p class="text-xs font-light">(Pemegang Kedaulatan Tertinggi)</p>
                </div>
            </div>
        `;
        
        const card = (jabatan, data) => `
            <div class="org-card shadow-lg">
                <img src="${data.foto || placeholderImg}" class="w-16 h-16 rounded-full object-cover mb-2 mx-auto bg-gray-200">
                
                <div class="org-card-title text-center">
                    <h4 class="font-bold text-sm leading-tight">${data.nama || '[Nama]'}</h4>
                    <p class="text-xs font-semibold mt-1">${jabatan}</p>
                    ${data.nip ? `<p class="text-xs text-gray-500 font-mono">${data.nip}</p>` : ''}
                </div>
                </div>
        `;

        let pengawasHtml = pengawas.map(p => card('Pengawas', p)).join('<div class="w-px org-connector h-4"></div>');
        let ketuaUnitHtml = ketuaUnit.map(ku => card('Ketua Unit', ku)).join('');

        return `<div class="struktur-organisasi space-y-4 p-4 bg-white dark:bg-gray-800 rounded-lg overflow-x-auto">
            <div class="flex flex-col items-center">
                <!-- Masyarakat -->
                ${masyarakatCard}
                <div class="w-px org-connector h-8"></div>

                <!-- Penasehat & Pengawas Level -->
                <div class="flex items-start justify-center w-full">
                    <!-- Main Branch -->
                    <div class="flex flex-col items-center">
                        <div class="relative">
                            ${card('Penasehat', penasihat)}
                            <!-- Dashed line connector to Pengawas -->
                            <div class="absolute top-1/2 left-full h-px w-24 org-connector org-connector-dashed"></div>
                        </div>
                        <div class="w-px org-connector h-8"></div>
                        ${card('Direktur', pengelola.direktur)}
                    </div>
                    <!-- Pengawas Branch -->
                    <div class="flex flex-col items-center pl-24 pt-16">
                        ${pengawasHtml}
                    </div>
                </div>
                
                <!-- Connector to Sekretaris/Bendahara -->
                <div class="w-px org-connector h-8"></div>
                <div class="w-3/5 border-t org-connector"></div>
                <div class="flex justify-center w-3/5">
                    <div class="w-px org-connector h-8"></div>
                    <div class="w-px org-connector h-8 ml-48"></div>
                </div>
                <div class="flex justify-center gap-32 -mt-8">
                    ${card('Sekretaris', pengelola.sekretaris)}
                    ${card('Bendahara', pengelola.bendahara)}
                </div>

                <!-- Unit Usaha -->
                ${ketuaUnit.length > 0 ? `
                <div class="w-full border-t org-connector mt-8"></div>
                <div class="flex justify-center"><div class="w-px org-connector h-8"></div></div>
                <div class="flex justify-center flex-wrap gap-8">${ketuaUnitHtml}</div>
                ` : ''}
            </div>
        </div>`;
    }
// FUNGSI BARU KHUSUS UNTUK MENCETAK BAGAN STRUKTUR (MENGGUNAKAN TABEL)
    function generateStrukturOrganisasiForPrint() {
        const { identitas } = sikBumdesData;
        const { penasihat, pengelola, pengawas, ketuaUnit } = identitas;
        const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMDAiIGhlaWdodD0iMTAwIiB2aWV3Qm94PSIwIDAgMTAwIDEwMCI+PHJlY3Qgd2lkdGg9IjEwMCIgaGVpZ2h0PSIxMDAiIGZpbGw9IiNlMmU4ZjAiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9InNhbnMtc2VyaWYiIGZvbnQtc-l6ZT0iNDBweCIgZmlsbD0iIzMzMyI+PzwvdGV4dD48L3N2Zz4=';

        // Fungsi kecil untuk membuat setiap kartu di dalam sel tabel
        const cardPrint = (jabatan, data) => `
            <div style="border: 1px solid #ccc; border-radius: 8px; padding: 10px; text-align: center; background: #f9f9f9; width: 190px; margin: 0 auto; page-break-inside: avoid;">
                <img src="${data.foto || placeholderImg}" style="width: 60px; height: 80px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">
                <p style="font-weight: bold; font-size: 12px; margin: 0 0 4px 0; line-height: 1.2;">${data.nama || '[Nama]'}</p>
                <p style="font-size: 11px; font-weight: bold; margin: 0 0 2px 0;">${jabatan}</p>
                ${data.nip ? `<p style="font-size: 10px; color: #555; margin: 0;">${data.nip}</p>` : ''}
            </div>
        `;
        
        // Membuat baris pengawas
        let pengawasHtml = '';
        if(pengawas.length > 0) {
            pengawasHtml = pengawas.map(p => `<td style="vertical-align: top; padding: 5px;">${cardPrint('Pengawas', p)}</td>`).join('');
        }

        // Membuat baris unit usaha
        let unitHtml = '';
        if (ketuaUnit.length > 0) {
            const unitCards = ketuaUnit.map(ku => `<td style="vertical-align: top; padding: 15px 5px;">${cardPrint('Ketua Unit', ku)}</td>`).join('');
            unitHtml = `
                <tr><td colspan="3" style="text-align:center; padding-top: 15px;"><div style="border-bottom: 1px solid #999; width:1px; height:15px; margin: 0 auto;"></div></td></tr>
                <tr>${unitCards}</tr>
            `;
        }
        
        // Menggabungkan semuanya dalam satu tabel besar
        return `
            <table style="width: 100%; border-collapse: collapse; font-family: sans-serif;">
                <tbody>
                    <tr>
                        <td colspan="3" style="text-align:center; padding-bottom: 15px;">${cardPrint('Penasehat', penasihat)}</td>
                    </tr>
                    <tr>
                        <td colspan="3" style="text-align:center;"><div style="border-bottom: 1px solid #999; width:1px; height:15px; margin: 0 auto;"></div></td>
                    </tr>
                    <tr>
                        <td style="width: 33%;"></td>
                        <td style="width: 34%; text-align: center; vertical-align: top;">
                            ${cardPrint('Direktur', pengelola.direktur)}
                            <div style="border-bottom: 1px solid #999; width:1px; height:15px; margin: 15px auto;"></div>
                        </td>
                        <td style="width: 33%; vertical-align: top; text-align: center;">
                            <table style="width: 100%; border-collapse: collapse;"><tbody><tr>${pengawasHtml}</tr></tbody></table>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="3">
                            <table style="width: 100%; border-collapse: collapse;">
                                <tbody>
                                    <tr>
                                        <td style="width: 50%; text-align: center; padding: 5px;">${cardPrint('Sekretaris', pengelola.sekretaris)}</td>
                                        <td style="width: 50%; text-align: center; padding: 5px;">${cardPrint('Bendahara', pengelola.bendahara)}</td>
                                    </tr>
                                    ${unitHtml}
                                </tbody>
                            </table>
                        </td>
                    </tr>
                </tbody>
            </table>
        `;
    }

     function generateShuReport(endDate) {
        const year = new Date(endDate).getFullYear();
        const firstDayOfYear = `${year}-01-01`;
        const labaRugiTahunBerjalan = calculateLabaRugiPeriod(firstDayOfYear, endDate);

        const { shu } = sikBumdesData;
        const bonus = (labaRugiTahunBerjalan * shu.bonusPengurus) / 100;
        const pendidikan = (labaRugiTahunBerjalan * shu.pendidikan) / 100;
        const danaSosial = (labaRugiTahunBerjalan * shu.danaSosial) / 100;
        const totalAlokasiAwal = bonus + pendidikan + danaSosial;
        const surplusSementara = labaRugiTahunBerjalan - totalAlokasiAwal;
        const paDesa = (surplusSementara * shu.paDesa) / 100;
        const penambahanModal = (surplusSementara * shu.penambahanModal) / 100;
        const totalAlokasiAkhir = paDesa + penambahanModal;

        return `<table class="w-full text-sm report-table">
            <thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-2 text-left">Peruntukan</th><th class="p-2 text-center">Persentase</th><th class="p-2 text-right">Jumlah (Rp)</th></tr></thead>
            <tbody>
                <tr><td colspan="3" class="level-1 pt-2">Laba Rugi Tahun Berjalan: ${formatCurrency(labaRugiTahunBerjalan)}</td></tr>
                <tr><td>Bonus Tahunan Perangkat BUM Desa</td><td class="text-center">${shu.bonusPengurus}%</td><td class="text-right">${formatCurrency(bonus)}</td></tr>
                <tr><td>Pendidikan (Capacity Building)</td><td class="text-center">${shu.pendidikan}%</td><td class="text-right">${formatCurrency(pendidikan)}</td></tr>
                <tr><td>Dana Sosial/CSR/TJSL/RTM</td><td class="text-center">${shu.danaSosial}%</td><td class="text-right">${formatCurrency(danaSosial)}</td></tr>
                <tr class="total-row"><td>Total</td><td></td><td class="text-right">${formatCurrency(totalAlokasiAwal)}</td></tr>
                <tr class="font-bold"><td>Surplus di tahan sementara</td><td></td><td class="text-right">${formatCurrency(surplusSementara)}</td></tr>
                <tr><td colspan="3" class="pt-4"></td></tr>
                <tr><td>Pendapatan Asli Desa (PA Desa)</td><td class="text-center">${shu.paDesa}%</td><td class="text-right">${formatCurrency(paDesa)}</td></tr>
                <tr><td>Surplus ditahan/Penambahan Modal</td><td class="text-center">${shu.penambahanModal}%</td><td class="text-right">${formatCurrency(penambahanModal)}</td></tr>
                <tr class="total-row"><td>Total</td><td></td><td class="text-right">${formatCurrency(totalAlokasiAkhir)}</td></tr>
            </tbody>
        </table>`;
    }
    
    function generateProfileBumdes(endDate) {
        const { identitas, shu, unitUsaha } = sikBumdesData;
        const allJurnal = getJurnalWithSaldoAwal();
        const { ledger } = calculateLedger(allJurnal, sikBumdesData.coa, endDate);
        const firstDayOfYear = new Date(endDate).getFullYear() + '-01-01';
        const labaRugiTahunBerjalan = calculateLabaRugiPeriod(firstDayOfYear, endDate);

        // Data Modal
        const currentYear = new Date().getFullYear();
        const years = Array.from({length: 6}, (_, i) => currentYear - 3 + i);
        let modalTableRows = '';
        const modalSources = [
            { key: 'danaDesa', label: 'Dana Desa' },
            { key: 'bantuanPusat', label: 'Bantuan Pemerintah Pusat' },
            { key: 'bantuanProvinsi', label: 'Bantuan Pemerintah Provinsi' },
            { key: 'bantuanKabupaten', label: 'Bantuan Pemerintah Kabupaten' },
            { key: 'lainLain', label: 'Bantuan lain (CSR dan Hibah lainnya)' },
            { key: 'pades', label: 'PADES' },
        ];
        modalSources.forEach(source => {
            modalTableRows += `<tr><td class="p-1 border">${source.label}</td>`;
            years.forEach((year, index) => {
                modalTableRows += `<td class="p-1 border text-right">${formatCurrency(identitas.modal[source.key][index] || 0)}</td>`;
            });
            modalTableRows += `</tr>`;
        });

        // Data Aset & Hutang
        let aktivaLancar = 0, aktivaTetap = 0, totalHutang = 0;
        Object.values(ledger).forEach(akun => {
            if (akun.no.startsWith('1.1')) aktivaLancar += akun.balance;
            if (akun.no.startsWith('1.2')) aktivaTetap += akun.balance;
            if (akun.no.startsWith('2')) totalHutang += akun.balance;
        });

        // Data Omzet & Biaya
        let totalPendapatan = 0, totalBiaya = 0;
        sikBumdesData.coa.filter(a => a.kelompok === 'LABA RUGI').forEach(akun => {
            const balance = ledger[akun.no]?.balance || 0;
            if (akun.saldoNormal === 'KREDIT') totalPendapatan += balance;
            else totalBiaya += balance;
        });

        // Data Pembagian Laba
        const bonus = (labaRugiTahunBerjalan * shu.bonusPengurus) / 100;
        const pendidikan = (labaRugiTahunBerjalan * shu.pendidikan) / 100;
        const danaSosial = (labaRugiTahunBerjalan * shu.danaSosial) / 100;
        const surplusSementara = labaRugiTahunBerjalan - (bonus + pendidikan + danaSosial);
        const paDesa = (surplusSementara * shu.paDesa) / 100;
        const penambahanModal = (surplusSementara * shu.penambahanModal) / 100;
        
        // Data Aspek Pelaporan
        const aspek = identitas.aspekPelaporan;
        const check = (isTrue) => isTrue ? 'V' : 'X';

        return `
            <div class="report-table text-sm">
                <h3 class="font-bold text-center text-lg">IDENTIFIKASI BADAN USAHA MILIK DESA (BUMDESA)</h3>
                <br>
                <table class="w-full mb-4">
                    <tr><td width="20%">Kecamatan</td><td>: ${identitas.alamat.kec}</td></tr>
                    <tr><td>Desa</td><td>: ${identitas.alamat.desa}</td></tr>
                    <tr><td>Nama Bumdes</td><td>: ${identitas.nama}</td></tr>
                    <tr><td>Alamat Kantor</td><td>: ${identitas.alamat.jalan}</td></tr>
                </table>

                <h4 class="font-bold mt-4">1. MODAL</h4>
                <table class="w-full text-xs border-collapse border">
                    <thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-1 border">Jenis Dana</th>${years.map(y => `<th class="p-1 border">${y}</th>`).join('')}</tr></thead>
                    <tbody>${modalTableRows}</tbody>
                </table>

                <h4 class="font-bold mt-4">2. ASET DAN HUTANG</h4>
                <table class="w-full">
                    <tr><td width="30%"><b>a. Aktiva Lancar</b></td><td></td><td class="text-right"><b>${formatCurrency(aktivaLancar)}</b></td></tr>
                    <tr><td><b>b. Aktiva Tetap</b></td><td></td><td class="text-right"><b>${formatCurrency(aktivaTetap)}</b></td></tr>
                    <tr class="total-row"><td class="font-bold">Total Aset</td><td></td><td class="text-right font-bold">${formatCurrency(aktivaLancar + aktivaTetap)}</td></tr>
                    <tr><td><b>c. Hutang</b></td><td></td><td class="text-right"><b>${formatCurrency(totalHutang)}</b></td></tr>
                </table>

                <h4 class="font-bold mt-4">3. OMZET (Pendapatan Kotor)</h4>
                <table class="w-full border-collapse border"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-1 border">Unit Usaha</th><th class="p-1 border">Omzet/Tahun</th></tr></thead>
                <tbody><tr><td class="p-1 border">Total Semua Unit</td><td class="p-1 border text-right">${formatCurrency(totalPendapatan)}</td></tr></tbody></table>

                <h4 class="font-bold mt-4">4. BIAYA-BIAYA / TAHUN</h4>
                <table class="w-full border-collapse border"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-1 border">Unit Usaha</th><th class="p-1 border">Total Biaya/Tahun</th></tr></thead>
                <tbody><tr><td class="p-1 border">Total Semua Unit</td><td class="p-1 border text-right">${formatCurrency(totalBiaya)}</td></tr></tbody></table>
                
                <h4 class="font-bold mt-4">5. LABA BERSIH</h4>
                <table class="w-full border-collapse border"><thead class="bg-gray-100 dark:bg-gray-700"><tr><th class="p-1 border">Unit Usaha</th><th class="p-1 border">Laba Bersih</th></tr></thead>
                <tbody><tr><td class="p-1 border">Total Semua Unit</td><td class="p-1 border text-right">${formatCurrency(labaRugiTahunBerjalan)}</td></tr></tbody></table>

                <h4 class="font-bold mt-4">6. PEMBAGIAN LABA BERSIH</h4>
                <table class="w-full text-xs border-collapse border"><thead class="bg-gray-100 dark:bg-gray-700"><tr>${['Laba Bersih', 'Bonus', 'Pendidikan', 'RTM', 'PADesa', 'Modal Ditahan'].map(h => `<th class="p-1 border">${h}</th>`).join('')}</tr></thead>
                <tbody><tr>
                    <td class="p-1 border text-right">${formatCurrency(labaRugiTahunBerjalan)}</td>
                    <td class="p-1 border text-right">${formatCurrency(bonus)}</td>
                    <td class="p-1 border text-right">${formatCurrency(pendidikan)}</td>
                    <td class="p-1 border text-right">${formatCurrency(danaSosial)}</td>
                    <td class="p-1 border text-right">${formatCurrency(paDesa)}</td>
                    <td class="p-1 border text-right">${formatCurrency(penambahanModal)}</td>
                </tr></tbody></table>

                <h4 class="font-bold mt-4">ASPEK PELAPORAN</h4>
                <div class="grid grid-cols-2 gap-x-4">
                    <div>
                        <h5 class="font-semibold mt-2">A. Administrasi Keuangan</h5>
                        <table class="w-full">
                            <tr><td width="70%">Buku Jurnal</td><td class="text-center">${check(aspek.bukuJurnal)}</td></tr>
                            <tr><td>Buku Besar</td><td class="text-center">${check(aspek.bukuBesar)}</td></tr>
                            <tr><td>Neraca Saldo</td><td class="text-center">${check(aspek.neracaSaldo)}</td></tr>
                        </table>
                    </div>
                    <div>
                        <h5 class="font-semibold mt-2">B. Laporan Keuangan</h5>
                        <table class="w-full">
                            <tr><td width="70%">Laporan Neraca</td><td class="text-center">${check(aspek.laporanNeraca)}</td></tr>
                            <tr><td>Laporan Laba Rugi</td><td class="text-center">${check(aspek.laporanLabaRugi)}</td></tr>
                            <tr><td>Laporan Perubahan Modal</td><td class="text-center">${check(aspek.laporanPerubahanModal)}</td></tr>
                        </table>
                    </div>
                    <div class="col-span-2">
                        <h5 class="font-semibold mt-2">C. Perencanaan Keuangan</h5>
                        <table class="w-full">
                            <tr><td width="35%">Cashflow</td><td class="text-center">${check(aspek.cashflow)}</td></tr>
                            <tr><td>RAPB</td><td class="text-center">${check(aspek.rapb)}</td></tr>
                            <tr><td>Rencana Kegiatan</td><td class="text-center">${check(aspek.rencanaKegiatan)}</td></tr>
                            <tr><td>Analisa Usaha</td><td class="text-center">${check(aspek.analisaUsaha)}</td></tr>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }
// ===================================================================================
    // --- MANAJEMEN PENGGUNA (FUNGSI YANG HILANG) ---
    // ===================================================================================
    function renderPenggunaTable() {
        const tbody = el('#pengguna-table-body');
        tbody.innerHTML = '';
        sikBumdesData.pengguna.forEach((user) => {
            const row = document.createElement('tr');
            row.className = 'border-b dark:border-gray-700';
            let actions = `<button class="btn-edit-pengguna text-blue-500 mr-2" data-username="${user.username}"><i class="fas fa-edit"></i></button>`;
            // Mencegah pengguna 'admin' dihapus
            if (user.username !== 'admin') {
                actions += `<button class="btn-delete-pengguna text-red-500" data-username="${user.username}"><i class="fas fa-trash"></i></button>`;
            }
            row.innerHTML = `<td class="p-3">${user.username}</td><td class="p-3">${user.peran}</td><td class="p-3">${actions}</td>`;
            tbody.appendChild(row);
        });

        all('.btn-edit-pengguna').forEach(btn => btn.addEventListener('click', (e) => showPenggunaModal(e.currentTarget.dataset.username)));
        all('.btn-delete-pengguna').forEach(btn => btn.addEventListener('click', (e) => deletePengguna(e.currentTarget.dataset.username)));
    }

    function showPenggunaModal(username = null) {
        const isEdit = username !== null;
        const user = isEdit ? sikBumdesData.pengguna.find(u => u.username === username) : { username: '', password: '', peran: 'Operator' };
        
        const modalHtml = `
            <div id="pengguna-modal" class="modal show fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg w-full max-w-md">
                    <h2 class="text-xl font-bold mb-4">${isEdit ? 'Edit' : 'Tambah'} Pengguna</h2>
                    <form id="form-pengguna">
                        <div class="mb-4">
                            <label>Username</label>
                            <input type="text" name="username" value="${user.username}" class="form-input" ${isEdit ? 'readonly' : ''} required>
                        </div>
                        <div class="mb-4">
                            <label>Password</label>
                            <input type="password" name="password" value="" class="form-input" ${isEdit ? '' : 'required'}>
                            ${isEdit ? '<p class="text-xs text-gray-500">Kosongkan jika tidak ingin mengubah password.</p>' : ''}
                        </div>
                        <div class="mb-4">
                            <label>Peran</label>
                            <select name="peran" class="form-input">
                                <option value="Admin" ${user.peran === 'Admin' ? 'selected' : ''}>Admin</option>
                                <option value="Operator" ${user.peran === 'Operator' ? 'selected' : ''}>Operator</option>
                            </select>
                        </div>
                        <div class="flex justify-end space-x-4">
                            <button type="button" id="btn-cancel-pengguna" class="bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Batal</button>
                            <button type="submit" class="bg-[var(--color-primary-start)] text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                        </div>
                    </form>
                </div>
            </div>`;
        
        el('#modal-container').innerHTML = modalHtml.replace(/class="form-input"/g, 'class="w-full p-2 border rounded dark:bg-gray-700 dark:border-gray-600"');
        
        el('#form-pengguna').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const newUsername = form.username.value;
            const newPassword = form.password.value;

            if (isEdit) {
                const userIndex = sikBumdesData.pengguna.findIndex(u => u.username === username);
                if (userIndex > -1) {
                    sikBumdesData.pengguna[userIndex].peran = form.peran.value;
                    if (newPassword) { // Hanya update password jika diisi
                        sikBumdesData.pengguna[userIndex].password = newPassword;
                    }
                }
            } else {
                if (sikBumdesData.pengguna.some(u => u.username === newUsername)) {
                    showNotification('Username sudah digunakan!', 'error');
                    return;
                }
                sikBumdesData.pengguna.push({
                    username: newUsername,
                    password: newPassword,
                    peran: form.peran.value
                });
            }
            saveData();
            renderPenggunaTable();
            closeModal('pengguna-modal');
            showNotification('Data pengguna berhasil disimpan!');
        });

        el('#btn-cancel-pengguna').addEventListener('click', () => closeModal('pengguna-modal'));
    }

    function deletePengguna(username) {
        if (username === 'admin') {
            showNotification('Pengguna admin tidak dapat dihapus.', 'error');
            return;
        }
        showConfirmationModal(`Yakin ingin menghapus pengguna '${username}'?`, () => {
            sikBumdesData.pengguna = sikBumdesData.pengguna.filter(u => u.username !== username);
            saveData();
            renderPenggunaTable();
            showNotification('Pengguna berhasil dihapus.');
        });
    }

    function loadPengaturan() {
        el('#logo-preview').src = sikBumdesData.pengaturan.logo;
        const formPajak = el('#form-pajak');
        const pajakRates = sikBumdesData.pengaturan.pajak;
        for (const key in pajakRates) {
            if (formPajak[key]) {
                formPajak[key].value = pajakRates[key];
            }
        }
    }
    // ===================================================================================
    // --- EVENT LISTENERS & APP START ---
    // ===================================================================================
    function addEventListeners() {
        // --- Authentication ---
        el('#login-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const username = e.target.username.value;
            const password = e.target.password.value;
            const user = sikBumdesData.pengguna.find(u => u.username === username && u.password === password);

            if (user) {
                sessionStorage.setItem('loggedInUser', JSON.stringify(user));
                el('#login-error').textContent = '';
                showApp();
                updateUserInfo(user);
                navigateTo('home');
            } else {
                el('#login-error').textContent = 'Username atau password salah.';
            }
        });
        el('#logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.removeItem('loggedInUser');
            showLogin();
        });

        // --- Navigation ---
        all('.nav-link').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const pageId = link.getAttribute('href').substring(1);
                navigateTo(pageId);
            });
        });
        el('#menu-toggle').addEventListener('click', () => {
            el('#sidebar').classList.toggle('-translate-x-full');
        });

        // --- UI ---
        el('#theme-toggle').addEventListener('click', () => {
            const html = document.documentElement;
            html.classList.toggle('dark');
            const isDark = html.classList.contains('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            el('#theme-toggle i').classList.toggle('fa-moon', !isDark);
            el('#theme-toggle i').classList.toggle('fa-sun', isDark);
        });

        // --- Input Data Page Buttons ---
        el('#btn-show-identitas').addEventListener('click', () => showIdentitasForm());
        el('#btn-show-kepengurusan').addEventListener('click', () => showKepengurusanForm());
        el('#btn-show-coa').addEventListener('click', () => showCoaTable());
        el('#btn-show-jurnal').addEventListener('click', () => showJurnalForm());
        el('#btn-show-inventaris').addEventListener('click', () => showInventarisForm());
        el('#btn-show-shu').addEventListener('click', () => showShuForm());
        el('#btn-show-saldo-awal').addEventListener('click', () => showSaldoAwalForm());

        // --- Unit Usaha ---
        el('#btn-tambah-unit').addEventListener('click', () => showUnitUsahaModal());

        // --- Laporan ---
        all('.btn-laporan').forEach(btn => {
            btn.addEventListener('click', () => {
                const reportType = btn.dataset.report;
                generateReport(reportType);
                all('.btn-laporan').forEach(b => b.classList.remove('bg-[var(--color-primary-start)]', 'text-white'));
                btn.classList.add('bg-[var(--color-primary-start)]', 'text-white');
            });
        });

        // --- Administrasi ---
        el('#form-upload-dokumen').addEventListener('submit', (e) => {
            e.preventDefault();
            const jenis = el('#select-jenis-dokumen').value;
            const fileInput = el('#input-file-dokumen');
            if (fileInput.files.length === 0) return showNotification('Pilih file terlebih dahulu!', 'error');
            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onloadend = function() {
                sikBumdesData.dokumen[jenis] = { name: file.name, type: file.type, data: reader.result };
                saveData();
                renderDokumenList();
                showNotification('Dokumen berhasil diupload.');
            }
            reader.readAsDataURL(file);
        });

       el('#btn-tampilkan-struktur').addEventListener('click', () => {
            const previewContainer = el('#struktur-preview-container');
            
            const headerHtml = generatePrintHeaderHtml('Bagan Struktur Organisasi', ''); 
            const chartHtml = generateStrukturOrganisasi();
            const fullPreviewHtml = headerHtml + chartHtml;
            
            previewContainer.innerHTML = `
                <div class="p-4 border dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800" id="struktur-content-to-print">
                    ${fullPreviewHtml}
                </div>
                <div class="mt-4 flex space-x-4 no-print">
                    <button id="btn-do-print-struktur" class="bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-700"><i class="fas fa-print mr-2"></i>Cetak</button>
                    <button id="btn-do-save-pdf-struktur" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700"><i class="fas fa-file-pdf mr-2"></i>Simpan ke PDF</button>
                </div>
            `;

            el('#btn-do-print-struktur').addEventListener('click', () => {
                const contentToPrint = el('#struktur-content-to-print').innerHTML;
                const printArea = el('#print-area');

                printArea.innerHTML = `
                    <style>
                        @media print {
                            @page { 
                                size: landscape; 
                                margin: 0.5in; 
                            }
                            body {
                                -webkit-print-color-adjust: exact !important; 
                                color-adjust: exact !important; 
                            }
                            .struktur-organisasi {
                                transform: scale(0.75) !important;
                                transform-origin: top center !important;
                                margin-top: -30px !important;
                            }
                        }
                    </style>
                    ${contentToPrint}
                `;
                
                // --- PERBAIKAN KUNCI ADA DI SINI ---
                printArea.classList.remove('hidden'); // <-- PERINTAH KUNCI YANG HILANG: Menyalakan 'proyektor'
                
                window.print();

                setTimeout(() => {
                    printArea.innerHTML = '';
                    printArea.classList.add('hidden'); // <-- Membersihkan & menyembunyikan kembali
                }, 500);
            });

            // Logika tombol Simpan ke PDF tidak berubah
            el('#btn-do-save-pdf-struktur').addEventListener('click', () => {
                 if (typeof html2pdf === 'undefined') {
                    showNotification('Gagal menyimpan PDF. Periksa koneksi internet Anda.', 'error');
                    return;
                }
                const element = el('#struktur-content-to-print');
                const opt = {
                    margin:       0.5,
                    filename:     'Struktur Organisasi BUMDes.pdf',
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true },
                    jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
                };
                html2pdf().from(element).set(opt).save();
            });
        });
        el('#form-musyawarah').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const id = form.musyawarahId.value;
            const record = {
                id: id || `mus_${Date.now()}`,
                tanggal: form.tanggal.value,
                hasil: form.hasil.value
            };
            if (id) {
                const index = sikBumdesData.musyawarah.findIndex(m => m.id === id);
                sikBumdesData.musyawarah[index] = record;
            } else {
                sikBumdesData.musyawarah.push(record);
            }
            saveData();
            renderMusyawarahList();
            form.reset();
            showNotification('Catatan musyawarah berhasil disimpan.');
        });

        // --- Pengaturan ---
        el('#btn-tambah-pengguna').addEventListener('click', () => showPenggunaModal());
        el('#logo-upload').addEventListener('change', (e) => {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = (event) => { el('#logo-preview').src = event.target.result; };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        el('#btn-simpan-logo').addEventListener('click', () => {
            sikBumdesData.pengaturan.logo = el('#logo-preview').src;
            saveData();
            showNotification('Logo berhasil disimpan!');
            renderDashboard();
        });
        all('.theme-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const themeName = e.currentTarget.dataset.theme;
                applyTheme(themeName);
            });
        });
        el('#btn-backup-data').addEventListener('click', () => {
            const dataStr = JSON.stringify(sikBumdesData);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `sik-bumdes-backup-${new Date().toISOString().slice(0,10)}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        });
        el('#restore-upload').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showConfirmationModal('Ini akan menimpa semua data saat ini. Lanjutkan?', () => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const restoredData = JSON.parse(event.target.result);
                        if (restoredData.identitas && restoredData.coa) {
                            localStorage.setItem('sikBumdesData', JSON.stringify(restoredData));
                            showNotification('Data berhasil dipulihkan! Aplikasi akan dimuat ulang.');
                            setTimeout(() => location.reload(), 2000);
                        } else { showNotification('File backup tidak valid.', 'error'); }
                    } catch (error) { showNotification('Gagal membaca file backup.', 'error'); }
                };
                reader.readAsText(file);
            });
        });
        el('#form-pajak').addEventListener('submit', (e) => {
            e.preventDefault();
            const form = e.target;
            const pajakRates = sikBumdesData.pengaturan.pajak;
            for (const key in pajakRates) {
                if (form[key]) {
                    pajakRates[key] = parseFloat(form[key].value) || 0;
                }
            }
            saveData();
            showNotification('Tarif pajak berhasil disimpan!');
        });
    }

    // --- Start the App ---
    addEventListeners();
    startMainApp();
};
</script>
</body>
</html>
